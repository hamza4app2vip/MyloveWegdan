<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💕 لحبيبتي وجدان الغالية 💕</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
     /* تصميم قسم رسائل تيليجرام المتقدم */
.telegram-messages-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    margin: 20px 0;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.telegram-messages-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
}

/* رأس القسم */
.telegram-section-header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.section-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.title-content {
    display: flex;
    align-items: center;
    gap: 15px;
}

.telegram-icon {
    font-size: 2rem;
    color: #00d4aa;
    animation: pulse 2s infinite;
}

.section-title h3 {
    color: white;
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

/* مؤشر الحالة */
.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-dot.connected { background: #4caf50; }
.status-dot.disconnected { background: #f44336; }
.status-dot.error { background: #ff9800; }
.status-dot.connecting { background: #2196f3; }

.status-text {
    color: white;
    font-weight: 500;
}

/* أزرار التحكم */
.section-controls {
    display: flex;
    gap: 10px;
}

.control-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

/* شريط الإحصائيات */
.stats-bar {
    display: flex;
    gap: 30px;
    justify-content: center;
}

.stat-item {
    text-align: center;
    color: white;
}

.stat-value {
    display: block;
    font-size: 1.8rem;
    font-weight: bold;
    color: #00d4aa;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
}

/* محتوى القسم */
.telegram-section-content {
    background: white;
    padding: 0;
}

.messages-container {
    max-height: 600px;
    overflow-y: auto;
    padding: 20px;
}

/* قائمة الرسائل */
.messages-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* عنصر الرسالة */
.message-item {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 15px;
    padding: 15px;
    border-left: 4px solid #667eea;
    transition: all 0.3s ease;
    opacity: 0;
    animation: fadeInUp 0.5s ease forwards;
}

.message-item:hover {
    transform: translateX(5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.message-item.recent {
    border-left-color: #4caf50;
    background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
}

.message-item.highlight {
    animation: highlight 3s ease;
}

/* رأس الرسالة */
.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.message-number {
    background: #667eea;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
}

.message-meta {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
    margin-left: 15px;
}

.author {
    font-weight: 600;
    color: #2c3e50;
}

.time {
    color: #7f8c8d;
    font-size: 0.9rem;
}

.edited-badge {
    background: #ff9800;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: bold;
}

.message-actions {
    display: flex;
    gap: 5px;
}

.action-icon {
    background: none;
    border: none;
    color: #7f8c8d;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
    transition: all 0.3s ease;
}

.action-icon:hover {
    background: #e9ecef;
    color: #495057;
}

/* محتوى الرسالة */
.message-content {
    margin: 10px 0;
}

.message-text {
    margin: 0;
    line-height: 1.6;
    color: #2c3e50;
    font-size: 1.05rem;
}

/* تذييل الرسالة */
.message-footer {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #e9ecef;
}

.quick-action {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.quick-action:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.quick-action.danger:hover {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
}

/* الحالة الفارغة */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-icon {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 20px;
}

.empty-state h4 {
    margin: 0 0 10px 0;
    color: #495057;
}

.empty-state p {
    margin: 0 0 30px 0;
    font-size: 1.1rem;
}

/* تذييل القسم */
.section-footer {
    background: #f8f9fa;
    padding: 20px;
    border-top: 1px solid #dee2e6;
}

.quick-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
}

.action-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.action-btn.secondary {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
}

.action-btn.primary {
    background: linear-gradient(135deg, #4caf50, #45a049);
}

.telegram-info {
    text-align: center;
    color: #6c757d;
    font-size: 0.9rem;
}

.telegram-info p {
    margin: 5px 0;
}

/* النوافذ المنبثقة */
.telegram-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: white;
    border-radius: 15px;
    max-width: 90%;
    max-height: 90%;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
}

.modal-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
    transition: background 0.3s ease;
}

.close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.modal-body {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

/* الرسائل في النافذة المنبثقة */
.message-item-full {
    display: flex;
    gap: 15px;
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
}

.message-number-full {
    background: #667eea;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.message-content-full {
    flex: 1;
}

.message-meta-full {
    display: flex;
    gap: 15px;
    margin-top: 10px;
    font-size: 0.9rem;
    color: #6c757d;
}

.message-meta-full .edited {
    background: #ff9800;
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.7rem;
}

/* الحركات والتأثيرات */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes highlight {
    0% { background: linear-gradient(135deg, #fff3cd, #ffeaa7); }
    100% { background: linear-gradient(135deg, #f8f9fa, #e9ecef); }
}

/* التصميم المتجاوب */
@media (max-width: 768px) {
    .telegram-section-header {
        padding: 15px;
    }
    
    .section-title {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .stats-bar {
        gap: 20px;
    }
    
    .message-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .message-meta {
        margin-left: 0;
    }
    
    .quick-actions {
        flex-direction: column;
    }
    
    .action-btn {
        justify-content: center;
    }
}

/* تحسينات إضافية */
.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-placeholder {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

/* تأثيرات التمرير */
.messages-container::-webkit-scrollbar {
    width: 8px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.messages-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 4px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a6fd8, #6a4190);
}
   
        /* تحسين أزرار المزاج */
.mood-btn {
    transition: all 0.3s ease;
    transform: scale(1);
    position: relative;
    overflow: hidden;
}

.mood-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
}

.mood-btn.selected {
    background: linear-gradient(135deg, #ff6b9d, #c44569) !important;
    color: white !important;
    transform: scale(1.1);
    box-shadow: 0 10px 30px rgba(255, 107, 157, 0.5);
    animation: selectedPulse 2s ease-in-out infinite;
}

.mood-btn.selected::after {
    content: '✓';
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 255, 255, 0.9);
    color: #ff6b9d;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}

@keyframes selectedPulse {
    0%, 100% { box-shadow: 0 10px 30px rgba(255, 107, 157, 0.5); }
    50% { box-shadow: 0 15px 40px rgba(255, 107, 157, 0.7); }
}

/* تحسين عرض تاريخ المزاج */
.mood-history-item {
    transition: all 0.3s ease;
}

.mood-history-item:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    transform: translateX(5px);
}

/* تحسين رسالة المزاج */
.mood-message {
    background: linear-gradient(135deg, rgba(255, 107, 157, 0.1), rgba(255, 192, 203, 0.1));
    border: 2px solid rgba(255, 107, 157, 0.2);
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-pink: #ff6b9d;
            --light-pink: #ffc0cb;
            --soft-pink: #ffb3d1;
            --rose-gold: #f7cac9;
            --blush: #ffeef0;
            --white: #ffffff;
            --dark-pink: #e91e63;
            --gradient-1: linear-gradient(135deg, #ff6b9d, #ffc0cb);
            --gradient-2: linear-gradient(45deg, #ff9a9e, #fecfef);
            --gradient-3: linear-gradient(135deg, #f093fb, #f5576c);
            --shadow: 0 10px 30px rgba(255, 107, 157, 0.3);
            --text-dark: #2c2c2c;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #ffeef0 0%, #fff0f5 50%, #ffe4e6 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="hearts" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><text x="10" y="15" text-anchor="middle" fill="%23ff6b9d" opacity="0.1" font-size="12">💕</text></pattern></defs><rect width="100" height="100" fill="url(%23hearts)"/></svg>');
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            box-shadow: 0 0 50px rgba(255, 107, 157, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .header {
            background: var(--gradient-1);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.1) 10px,
                rgba(255, 255, 255, 0.1) 20px
            );
            animation: slide 15s linear infinite;
        }

        @keyframes slide {
            0% { transform: translateX(-50px); }
            100% { transform: translateX(50px); }
        }

        .header h1 {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            position: relative;
            z-index: 2;
        }

        .floating-hearts {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .heart {
            position: absolute;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.5rem;
            animation: floatUp 6s ease-in-out infinite;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .nav-tabs {
            display: flex;
            background: white;
            box-shadow: 0 2px 10px rgba(255, 107, 157, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            color: var(--primary-pink);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 0.9rem;
        }

        .nav-tab.active {
            background: var(--gradient-1);
            color: white;
        }

        .nav-tab:hover {
            background: var(--blush);
        }

        .nav-tab.active:hover {
            background: var(--gradient-1);
        }

        .content {
            padding: 20px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 192, 203, 0.3);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 107, 157, 0.4);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark-pink);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .counter-display {
            text-align: center;
            padding: 30px;
            background: var(--gradient-2);
            border-radius: 20px;
            color: white;
            margin-bottom: 20px;
        }

        .counter-number {
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .counter-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .love-meter {
            background: var(--gradient-2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .meter-container {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b9d, #ffffff);
            border-radius: 25px;
            width: 0%;
            transition: width 2s ease-in-out;
            position: relative;
        }

        .meter-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .weather-widget {
            background: var(--gradient-3);
            border-radius: 20px;
            padding: 25px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .weather-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .mood-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .mood-btn {
            background: white;
            border: 2px solid var(--light-pink);
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        .mood-btn:hover, .mood-btn.selected {
            background: var(--gradient-1);
            color: white;
            transform: scale(1.1);
        }

        .quote-container {
            background: var(--blush);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid var(--primary-pink);
            position: relative;
        }

        .quote-text {
            font-style: italic;
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--text-dark);
        }

        .quote-author {
            text-align: left;
            margin-top: 10px;
            color: var(--dark-pink);
            font-weight: 600;
        }

        .memory-timeline {
            position: relative;
            padding-right: 30px;
        }

        .memory-timeline::before {
            content: '';
            position: absolute;
            right: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gradient-1);
        }

        .memory-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.2);
        }

        .memory-item::after {
            content: '';
            position: absolute;
            right: -25px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: var(--primary-pink);
            border-radius: 50%;
            border: 3px solid white;
        }

        .memory-date {
            color: var(--dark-pink);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .memory-text {
            line-height: 1.6;
        }

        .interactive-game {
            background: var(--gradient-2);
            border-radius: 20px;
            padding: 25px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .game-cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .game-cell:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .music-player {
            background: var(--gradient-1);
            border-radius: 20px;
            padding: 25px;
            color: white;
            margin-bottom: 20px;
        }

        .music-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .music-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .music-btn.play {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            width: 0%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .calendar-widget {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: var(--primary-pink);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-nav:hover {
            background: var(--dark-pink);
            transform: scale(1.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .calendar-day:hover {
            background: var(--blush);
        }

        .calendar-day.today {
            background: var(--primary-pink);
            color: white;
        }

        .calendar-day.special {
            background: var(--gradient-1);
            color: white;
            position: relative;
        }

        .calendar-day.special::after {
            content: '💕';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
        }

        .notification-center {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .notification {
            background: var(--blush);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid var(--primary-pink);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--dark-pink);
            margin-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--gradient-2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: white;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .voice-message {
            background: var(--gradient-1);
            border-radius: 20px;
            padding: 25px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .voice-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            margin: 15px;
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .voice-btn.recording {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .surprise-box {
            background: var(--gradient-3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .surprise-box:hover {
            transform: scale(1.05);
        }

        .surprise-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .footer {
            background: var(--gradient-1);
            padding: 30px 20px;
            text-align: center;
            color: white;
            margin-top: 40px;
        }

        .footer-heart {
            font-size: 2rem;
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.3); }
            70% { transform: scale(1); }
        }

        .btn {
            background: var(--gradient-1);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-pink);
            border: 2px solid var(--primary-pink);
        }

        .btn-secondary:hover {
            background: var(--primary-pink);
            color: white;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-pink);
            font-weight: 600;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--light-pink);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--primary-pink);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--gradient-1);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .content {
                padding: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .counter-number {
                font-size: 2.5rem;
            }
            
            .nav-tab {
                padding: 12px 8px;
                font-size: 0.8rem;
            }
        }

        .sparkle {
            position: absolute;
            color: var(--primary-pink);
            font-size: 1rem;
            animation: sparkle 2s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        .typing-indicator {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="floating-hearts" id="floatingHearts"></div>
            <h1>💕 لحبيبتي الغالية 💕</h1>
            <p class="subtitle">أجمل ما في الحياة هو وجودك معي</p>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('home')">
                <i class="fas fa-home"></i><br>الرئيسية
            </button>
            <button class="nav-tab" onclick="showTab('memories')">
                <i class="fas fa-heart"></i><br>ذكرياتنا
            </button>
            <button class="nav-tab" onclick="showTab('games')">
                <i class="fas fa-gamepad"></i><br>ألعاب
            </button>
            <button class="nav-tab" onclick="showTab('tools')">
                <i class="fas fa-magic"></i><br>أدوات
            </button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Home Tab -->
            <div id="home" class="tab-content active">
                <!-- Love Counter -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-calendar-heart"></i>
                        عداد أيام حبنا
                    </h3>
                    <div class="counter-display">
                        <div class="counter-number" id="daysCounter">0</div>
                        <div class="counter-label">يوم من الحب والسعادة</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="hoursCounter">0</div>
                            <div class="stat-label">ساعة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="minutesCounter">0</div>
                            <div class="stat-label">دقيقة</div>
                        </div>
                    </div>
                </div>

                <!-- Love Meter -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-heart-pulse"></i>
                        مقياس الحب
                    </h3>
                    <div class="love-meter">
                        <h4>مستوى حبي لك اليوم</h4>
                        <div class="meter-container">
                            <div class="meter-fill" id="loveMeter"></div>
                        </div>
                        <p id="lovePercentage">100%</p>
                    </div>
                </div>

                <!-- Weather of Love -->
                <div class="weather-widget">
                    <h3><i class="fas fa-cloud-sun"></i> طقس الحب اليوم</h3>
                    <div class="weather-icon" id="weatherIcon">☀️</div>
                    <h4 id="weatherStatus">مشمس مع نسمات من الحب</h4>
                    <p id="weatherDesc">درجة الحرارة: ♾️ درجة حب</p>
                </div>

                <!-- Daily Quote -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-quote-right"></i>
                        اقتباس اليوم
                    </h3>
                    <div class="quote-container">
                        <p class="quote-text" id="dailyQuote">
                            "الحب ليس مجرد شعور، بل هو قرار نتخذه كل يوم لنكون مع الشخص الذي نحبه"
                        </p>
                        <p class="quote-author">- حمزة حبيبك</p>
                    </div>
                    <button class="btn" onclick="getNewQuote()">اقتباس جديد</button>
                </div>

                <!-- Mood Tracker -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-smile"></i>
                        كيف مزاجك اليوم؟
                    </h3>
                    <div class="mood-selector">
                        <div class="mood-btn" onclick="selectMood('happy', '😊')">😊</div>
                        <div class="mood-btn" onclick="selectMood('love', '😍')">😍</div>
                        <div class="mood-btn" onclick="selectMood('excited', '🤩')">🤩</div>
                        <div class="mood-btn" onclick="selectMood('calm', '😌')">😌</div>
                        <div class="mood-btn" onclick="selectMood('romantic', '🥰')">🥰</div>
                        <div class="mood-btn" onclick="selectMood('dreamy', '😴')">😴</div>
                        <div class="mood-btn" onclick="selectMood('playful', '😜')">😜</div>
                        <div class="mood-btn" onclick="selectMood('grateful', '😔')">😔</div>
                    </div>
                    <p id="moodMessage">اختاري مزاجك لأرسل لك رسالة مناسبة 💕</p>
                </div>
            </div>

            <!-- Memories Tab -->
            <div id="memories" class="tab-content">
                <!-- Memory Timeline -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-timeline"></i>
                        خط زمني لذكرياتنا
                    </h3>
                    <div class="memory-timeline" id="memoryTimeline">
                        <!-- Memories will be loaded here -->
                    </div>
                    <button class="btn" onclick="addMemory()">إضافة ذكرى جديدة</button>
                </div>

                <!-- Special Dates Calendar -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-calendar-check"></i>
                        تقويم المناسبات الخاصة
                    </h3>
                    <div class="calendar-widget">
                        <div class="calendar-header">
                            <button class="calendar-nav" onclick="changeMonth(-1)">‹</button>
                            <h4 id="currentMonth">يناير 2024</h4>
                            <button class="calendar-nav" onclick="changeMonth(1)">›</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Love Letters -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-envelope-heart"></i>
                        رسائل الحب
                    </h3>
                    <div id="loveLetters">
                        <!-- Love letters will be displayed here -->
                    </div>
                    <button class="btn" onclick="writeLoveLetter()">كتابة رسالة حب</button>
                </div>
            </div>

            <!-- Games Tab -->
            <div id="games" class="tab-content">
                <!-- Love Quiz -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-question-circle"></i>
                        اختبار الحب
                    </h3>
                    <div id="quizContainer">
                        <p>كم تعرفين عني؟ اختبري معلوماتك!</p>
                        <button class="btn" onclick="startQuiz()">ابدأ الاختبار</button>
                    </div>
                </div>

                <!-- Memory Game -->
                <div class="interactive-game">
                    <h3><i class="fas fa-brain"></i> لعبة الذاكرة</h3>
                    <p>اعثري على القلوب المتطابقة!</p>
                    <div class="game-grid" id="memoryGame">
                        <!-- Memory game grid will be generated here -->
                    </div>
                    <button class="btn btn-secondary" onclick="startMemoryGame()">لعبة جديدة</button>
                </div>

                <!-- Love Calculator -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-calculator"></i>
                        حاسبة الحب
                    </h3>
                    <div class="input-group">
                        <label>اسمك:</label>
                        <input type="text" id="name1" placeholder="أدخلي اسمك">
                    </div>
                    <div class="input-group">
                        <label>اسمي:</label>
                        <input type="text" id="name2" placeholder="أدخلي اسمي">
                    </div>
                    <button class="btn" onclick="calculateLove()">احسبي نسبة الحب</button>
                    <div id="loveResult"></div>
                </div>

                <!-- Surprise Box -->
                <div class="surprise-box" onclick="openSurprise()">
                    <div class="surprise-icon">🎁</div>
                    <h3>صندوق المفاجآت</h3>
                    <p>اضغطي لتحصلي على مفاجأة!</p>
                </div>
            </div>

            <!-- Tools Tab -->
            <div id="tools" class="tab-content">
                <!-- Music Player -->
                <div class="music-player">
                    <h3><i class="fas fa-music"></i> مشغل الموسيقى الرومانسية</h3>
                    <div id="currentSong">أغنية الحب الأولى</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="musicProgress"></div>
                    </div>
                    <div class="music-controls">
                        <button class="music-btn" onclick="previousSong()">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="music-btn play" onclick="togglePlay()" id="playBtn">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="music-btn" onclick="nextSong()">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                </div>

                <!-- Voice Messages -->
                <div class="voice-message">
                    <h3><i class="fas fa-microphone"></i> رسائل صوتية</h3>
                    <p>سجلي رسالة صوتية لي 💕</p>
                    <button class="voice-btn" onclick="toggleRecording()" id="recordBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <div id="voiceMessages">
                        <!-- Voice messages will be displayed here -->
                    </div>
                </div>

                <!-- Notification Center -->
                <div class="notification-center">
                    <h3 class="card-title">
                        <i class="fas fa-bell"></i>
                        مركز الإشعارات
                    </h3>
                    <div id="notifications">
                        <!-- Notifications will be displayed here -->
                    </div>
                    <button class="btn" onclick="addReminder()">إضافة تذكير</button>
                </div>
<div class="card">
    <h3 class="card-title">
        <i class="fab fa-telegram"></i>
        لوحة تحكم تيليجرام
    </h3>
    <div class="telegram-setup">
        <p><strong>الجهة المرسلة اليها:</strong> خاص </p>
        <p><strong>حالة الاتصال:</strong> <span id="connectionStatus">غير محدد</span></p>
        
        <div class="button-group">
            <button class="btn" onclick="getChatId()">الحصول على Chat ID</button>
            <button class="btn" onclick="testTelegramConnection()">تحقيق اتصال ناجح</button>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <h4>إحصائيات الإرسال:</h4>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="sentCount">0</div>
                <div class="stat-label">رسالة مرسلة</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedCount">0</div>
                <div class="stat-label">رسالة فاشلة</div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="showTelegramLogs()">عرض سجل الإرسال</button>
        <button class="btn btn-secondary" onclick="clearTelegramLogs()">مسح السجل</button>
    </div>
</div>
                <!-- Love Statistics -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-heart"></i>
                        إحصائيات الحب
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="messagesCount">∞</div>
                            <div class="stat-label"> كلام حب</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="smilesCount">∞</div>
                            <div class="stat-label">ابتسامة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="hugsCount">12000</div>
                            <div class="stat-label">وسائط</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="kissesCount">290,000</div>
                            <div class="stat-label">رسالة</div>
                        </div>
                    </div>
                </div>

                <!-- Weather Forecast -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-cloud-sun"></i>
                        توقعات طقس الحب
                    </h3>
                    <div id="weatherForecast">
                        <!-- Weather forecast will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-heart">💕</div>
            <p>صُنع بكل الحب والشوق</p>
            <p>لأجمل حبيبة في العالم</p>
            <div class="typing-indicator">
                <span>.</span><span>.</span><span>.</span>
            </div>
        </div>
      </div>
    <!-- Modals -->
    <div id="memoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('memoryModal')">&times;</span>
            <h3>إضافة ذكرى جديدة</h3>
            <div class="input-group">
                <label>التاريخ:</label>
                <input type="date" id="memoryDate">
            </div>
            <div class="input-group">
                <label>الذكرى:</label>
                <textarea id="memoryText" rows="4" placeholder="اكتبي الذكرى الجميلة..."></textarea>
            </div>
            <button class="btn" onclick="saveMemory()">حفظ الذكرى</button>
        </div>
    </div>

    <div id="letterModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('letterModal')">&times;</span>
            <h3>كتابة رسالة حب</h3>
            <div class="input-group">
                <label>العنوان:</label>
                <input type="text" id="letterTitle" placeholder="عنوان الرسالة">
            </div>
            <div class="input-group">
                <label>الرسالة:</label>
                <textarea id="letterContent" rows="6" placeholder="اكتبي رسالة الحب..."></textarea>
            </div>
            <button class="btn" onclick="saveLetter()">إرسال الرسالة</button>
        </div>
    </div>

    <div id="reminderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('reminderModal')">&times;</span>
            <h3>إضافة تذكير</h3>
            <div class="input-group">
                <label>نوع التذكير:</label>
                <select id="reminderType">
                    <option value="daily">يومي</option>
                    <option value="weekly">أسبوعي</option>
                    <option value="monthly">شهري</option>
                    <option value="special">مناسبة خاصة</option>
                </select>
            </div>
            <div class="input-group">
                <label>الرسالة:</label>
                <input type="text" id="reminderText" placeholder="نص التذكير">
            </div>
            <div class="input-group">
                <label>الوقت:</label>
                <input type="time" id="reminderTime">
            </div>
            <button class="btn" onclick="saveReminder()">حفظ التذكير</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
    // دالة اختبار الاتصال المحسنة
async function testTelegramConnection() {
    const statusElement = document.getElementById('connectionStatus');
    
    if (!statusElement) {
        console.log('عنصر الحالة غير موجود');
        return;
    }
    
    statusElement.textContent = 'جاري الاختبار...';
    statusElement.style.color = 'orange';
    
    try {
        // أولاً: اختبار معلومات البوت
        const botInfoResponse = await fetch(`https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/getMe`);
        const botInfo = await botInfoResponse.json();
        
        if (!botInfo.ok) {
            throw new Error('التوكن غير صحيح');
        }
        
        console.log('معلومات البوت:', botInfo.result);
        
        // ثانياً: محاولة الحصول على Chat ID الصحيح
        await getChatId();
        
        // ثالثاً: إرسال رسالة اختبار
        const testResult = await sendToTelegram(
            'اختبار الاتصال', 
            'مرحباً! هذه رسالة اختبار للتأكد من عمل البوت بشكل صحيح! 🤖✅\n\nإذا وصلتك هذه الرسالة، فإن الإعداد تم بنجاح! 🎉', 
            'test'
        );
        
        if (testResult) {
            statusElement.textContent = 'متصل ✅';
            statusElement.style.color = 'green';
            showToast('تم الاتصال بنجاح! تحقق من تيليجرام 📱');
        } else {
            throw new Error('فشل في إرسال رسالة الاختبار');
        }
        
    } catch (error) {
        console.error('خطأ في الاختبار:', error);
        statusElement.textContent = 'غير متصل ❌';
        statusElement.style.color = 'red';
        showToast(`خطأ: ${error.message}`);
    }
    
    updateTelegramStats();
}

    // دالة للحصول على Chat ID الصحيح
async function getChatId() {
    try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/getUpdates`);
        const data = await response.json();
        
        if (data.ok && data.result.length > 0) {
            // البحث عن آخر رسالة
            const lastMessage = data.result[data.result.length - 1];
            const chatId = lastMessage.message.chat.id;
            
            console.log('Chat ID المكتشف:', chatId);
            
            // تحديث الإعدادات
            TELEGRAM_CONFIG.CHAT_ID = chatId.toString();
            
            showToast(`تم العثور على Chat ID: ${chatId}`);
            return chatId;
        } else {
            showToast('لم يتم العثور على رسائل. أرسل رسالة للبوت أولاً!');
            return null;
        }
    } catch (error) {
        console.error('خطأ في الحصول على Chat ID:', error);
        showToast('خطأ في الحصول على Chat ID');
        return null;
    }
}

    
        // إعدادات تيليجرام// إعدادات تيليجرام مع بياناتك
const TELEGRAM_CONFIG = {
    BOT_TOKEN: '7619744256:AAGlTErNoXyRAoBwNO0f8SNwDBzIA2y1Pws', // توكن البوت الخاص بك
    CHAT_ID: '7619744256',     // معرف المحادثة (نفس ID البوت مؤقتاً)
    enabled: true              // مفعل
};

// دالة إرسال الرسائل عبر تيليجرام
async function sendToTelegram(title, content, type = 'love_letter') {
    // التحقق من تفعيل الخدمة
    if (!TELEGRAM_CONFIG.enabled || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) {
        console.log('تيليجرام غير مفعل أو الإعدادات ناقصة');
        return false;
    }

    // تنسيق الرسالة حسب النوع
    let message = '';
    let emoji = '';
    
    switch(type) {
        case 'love_letter':
            emoji = '💌';
            message = `${emoji} رسالة حب جديدة ${emoji}\n\n`;
            message += `📝 العنوان: ${title}\n\n`;
            message += `💕 الرسالة:\n${content}\n\n`;
            break;
            
        case 'memory':
            emoji = '💭';
            message = `${emoji} ذكرى جديدة ${emoji}\n\n`;
            message += `📅 التاريخ: ${title}\n\n`;
            message += `💖 الذكرى:\n${content}\n\n`;
            break;
            
        case 'mood':
            emoji = '😊';
            message = `${emoji} تحديث المزاج ${emoji}\n\n`;
            message += `🎭 المزاج: ${title}\n`;
            message += `💭 الرسالة: ${content}\n\n`;
            break;
            
        case 'test':
            emoji = '🤖';
            message = `${emoji} اختبار الاتصال ${emoji}\n\n`;
            message += `${content}\n\n`;
            break;
            
        default:
            emoji = '💕';
            message = `${emoji} رسالة جديدة ${emoji}\n\n${content}\n\n`;
    }
    
    // إضافة الوقت والتاريخ
    message += `⏰ الوقت: ${new Date().toLocaleString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    })}\n\n`;
    
    message += `💖 من حبيبتك الغالية 💖`;

    // رابط API تيليجرام
    const telegramURL = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`;
    
    try {
        // عرض رسالة تحميل
        showToast('جاري إرسال الرسالة... ⏳');
        
        // إرسال الطلب
        const response = await fetch(telegramURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: TELEGRAM_CONFIG.CHAT_ID,
                text: message,
                parse_mode: 'HTML',
                disable_web_page_preview: true
            })
        });

        // التحقق من نجاح الإرسال
        if (response.ok) {
            const result = await response.json();
            if (result.ok) {
                showToast('تم إرسال الرسالة بنجاح! 📱💕');
                
                // حفظ سجل الإرسال
                saveTelegramLog(title, content, type, 'success');
                
                // إضافة تأثير بصري
                createSparkle();
                createSparkle();
                
                return true;
            } else {
                throw new Error(result.description || 'خطأ من تيليجرام');
            }
        } else {
            throw new Error(`HTTP Error: ${response.status}`);
        }
        
    } catch (error) {
        console.error('خطأ في إرسال الرسالة:', error);
        showToast('فشل في إرسال الرسالة 😔');
        
        // حفظ سجل الخطأ
        saveTelegramLog(title, content, type, 'failed', error.message);
        
        return false;
    }
}

// دالة حفظ سجل الإرسال
function saveTelegramLog(title, content, type, status, error = null) {
    const logs = JSON.parse(localStorage.getItem('telegramLogs') || '[]');
    logs.push({
        title,
        content: content.substring(0, 100) + '...', // حفظ أول 100 حرف فقط
        type,
        status,
        error,
        timestamp: new Date().toISOString(),
        id: Date.now()
    });
    
    // الاحتفاظ بآخر 50 سجل فقط
    if (logs.length > 50) {
        logs.splice(0, logs.length - 50);
    }
    
    localStorage.setItem('telegramLogs', JSON.stringify(logs));
}


        // Global Variables
        let currentTab = 'home';
        let loveStartDate = new Date('2023-06-2'); // تغيير التاريخ حسب بداية العلاقة
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let isPlaying = false;
        let isRecording = false;
        let currentSongIndex = 0;
        let memoryGameCards = [];
        let flippedCards = [];
        let gameScore = 0;

        // Love quotes array
        const loveQuotes = [
            "الحب هو الشيء الوحيد الذي يزداد عندما نقسمه",
            "أنت لست مجرد حبيبتي، بل أنت حياتي كلها",
            "في عينيك أرى مستقبلي، وفي قلبك أجد بيتي",
            "الحب الحقيقي لا يعرف المسافات ولا الزمن",
            "أنت السبب في أن كل يوم يبدو وكأنه عيد",
            "حبك يجعل العالم أجمل والحياة أحلى",
            "وجودك مهم للغاية أنتي اكسجين",
"باذن الله تكوني لي وأنا لكِ أنتي",
"من اركان حياتي الاساسية وجدان انتي حبيبتي",
            "معك تعلمت أن الحب ليس مجرد كلمة بل حياة كاملة"
        ];

        // Songs array
        const songs = [
            "أغنية الحب الأولى",
            "لحن القلوب",
            "سيمفونية العشق",
            "نغمة الشوق",
            "أنشودة الحب"
        ];

        // Weather statuses
        const weatherStatuses = [
            { icon: "☀️", status: "مشمس مع نسمات من الحب", desc: "درجة الحرارة: ♾️ درجة حب" },
            { icon: "🌙", status: "ليلة رومانسية تحت النجوم", desc: "احتمالية الرومانسية: 100%" },
            { icon: "🌈", status: "قوس قزح من المشاعر", desc: "الرطوبة: مشبعة بالحب" },
            { icon: "💫", status: "عاصفة من النجوم والأحلام", desc: "سرعة الرياح: نسيم الحنان" },
            { icon: "🌸", status: "ربيع دائم في القلب", desc: "الضغط الجوي: مرتفع بالسعادة" }
        ];

        // Mood messages
        const moodMessages = {
            happy: "سعيدة أنك سعيدة! ابتسامتك تضيء يومي 😊",
            love: "أحبك أكثر مما تتخيلين! 😍💕",
            excited: "حماسك معدي! دعينا نصنع ذكريات جميلة 🤩",
            calm: "الهدوء معك أجمل شعور في العالم 😌",
            romantic: "أنت في مزاج رومانسي؟ أنا أيضاً! 🥰",
            dreamy: "أحلام سعيدة يا حبيبتي 😴💤",
            playful: "أحب روحك المرحة! 😜🎉",
            grateful: "حبيبك معك لا  تحزني حبيبتي"
        };

        // Quiz questions
        const quizQuestions = [
            {
                question: "اكلة اشتيها من يدك",
                options: ["دجاج", "اي شي المهم منك", "خبز", "سمك"],
                correct: 1
            },
            {
                question: "ايش اكثر شي يعجبنا فيك",
                options: ["جمالي", "صوتي", "كل شي", "اناقتي"],
                correct: 2
            },
            {
                question: "شي اتمناه منك",
                options: ["قربك", "صوتك", "كلامك", "اتمنى وجدان"],
                correct: 3
            }
        ];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            startCounters();
            generateCalendar();
            loadMemories();
            loadLoveLetters();
            loadNotifications();
            createFloatingHearts();
            updateWeather();
            animateLoveMeter();
            loadWeatherForecast();
            startMemoryGame();
        });

        function initializeApp() {
            // Set initial love meter
            setTimeout(() => {
                document.getElementById('loveMeter').style.width = '100%';
            }, 1000);

            // Add sparkle effects
            setInterval(createSparkle, 2000);

            // Update statistics
            updateStatistics();
        }

        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Update nav buttons
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            event.target.closest('.nav-tab').classList.add('active');

            currentTab = tabName;
        }

        function startCounters() {
            function updateCounters() {
                const now = new Date();
                const diff = now - loveStartDate;
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                document.getElementById('daysCounter').textContent = days;
                document.getElementById('hoursCounter').textContent = hours;
                document.getElementById('minutesCounter').textContent = minutes;
            }

            updateCounters();
            setInterval(updateCounters, 60000); // Update every minute
        }

        function animateLoveMeter() {
            const meter = document.getElementById('loveMeter');
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                } else {
                    width++;
                    meter.style.width = width + '%';
                }
            }, 20);
        }

        function getNewQuote() {
            const randomQuote = loveQuotes[Math.floor(Math.random() * loveQuotes.length)];
            document.getElementById('dailyQuote').textContent = randomQuote;
            showToast('تم تحديث الاقتباس! 💕');
        }

        function selectMood(mood, emoji) {
            // Remove previous selection
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Add selection to clicked button
            event.target.classList.add('selected');

            // Update mood message
            document.getElementById('moodMessage').textContent = moodMessages[mood];
            
            showToast(`مزاجك! ${emoji}`);
        }

        function updateWeather() {
            const randomWeather = weatherStatuses[Math.floor(Math.random() * weatherStatuses.length)];
            document.getElementById('weatherIcon').textContent = randomWeather.icon;
            document.getElementById('weatherStatus').textContent = randomWeather.status;
            document.getElementById('weatherDesc').textContent = randomWeather.desc;
        }

    function generateCalendar() {
    const monthNames = [
        'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
        'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
    ];

    // المناسبات المختلفة مع 3 مناسبات فقط
    const specialEvents = {
        // ذكريات شخصية
        personal: {
            '5-5': { message: 'ميلاد حبيبك', emoji: '💕' }
        },
        // أعياد ومناسبات
        holidays: {
            '5-2': { message: 'عيد الحب', emoji: '💖' }
        },
        // أعياد ميلاد
        birthdays: {
            '2-25': { message: 'عيد ميلادك', emoji: '🎂' }
        }
    };

    document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();

    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';

    // Add day headers
    const dayHeaders = ['أح', 'إث', 'ث', 'أر', 'خ', 'ج', 'س'];
    dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.textContent = day;
        dayHeader.style.fontWeight = 'bold';
        dayHeader.style.color = 'var(--primary-pink)';
        dayHeader.style.padding = '10px 5px';
        dayHeader.style.textAlign = 'center';
        calendarGrid.appendChild(dayHeader);
    });

    // Add empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        calendarGrid.appendChild(emptyDay);
    }

    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        // التحقق من المناسبات الخاصة
        const dateKey = `${currentMonth}-${day}`;
        let isSpecial = false;
        let eventInfo = null;
        let eventType = '';

        // البحث في جميع أنواع المناسبات
        if (specialEvents.personal[dateKey]) {
            isSpecial = true;
            eventInfo = specialEvents.personal[dateKey];
            eventType = 'personal';
        } else if (specialEvents.holidays[dateKey]) {
            isSpecial = true;
            eventInfo = specialEvents.holidays[dateKey];
            eventType = 'holiday';
        } else if (specialEvents.birthdays[dateKey]) {
            isSpecial = true;
            eventInfo = specialEvents.birthdays[dateKey];
            eventType = 'birthday';
        }

        // تطبيق التنسيق للأيام المميزة
        if (isSpecial) {
            dayElement.classList.add('special', eventType);
            dayElement.title = `${eventInfo.emoji} ${eventInfo.message}`;
            dayElement.innerHTML = `
                <div style="font-weight: bold;">${day}</div>
                <div style="font-size: 0.8rem; margin-top: 2px;">${eventInfo.emoji}</div>
            `;
            
            // إضافة تأثير نبضة للأيام المميزة
            dayElement.style.animation = 'heartbeat 2s ease-in-out infinite';
            
            // إضافة حدث النقر لإظهار رسالة
            dayElement.addEventListener('click', () => {
                showToast(`${eventInfo.emoji} ${eventInfo.message}`);
                createSparkle();
            });
        } else {
            dayElement.textContent = day;
        }

        // Mark today
        if (currentYear === today.getFullYear() && 
            currentMonth === today.getMonth() && 
            day === today.getDate()) {
            dayElement.classList.add('today');
            if (!isSpecial) {
                dayElement.style.background = 'var(--primary-pink)';
                dayElement.style.color = 'white';
            }
        }

        // إضافة تأثير التمرير للأيام العادية
        if (!isSpecial) {
            dayElement.addEventListener('mouseenter', () => {
                dayElement.style.background = 'var(--blush)';
                dayElement.style.transform = 'scale(1.1)';
            });
            
            dayElement.addEventListener('mouseleave', () => {
                if (!dayElement.classList.contains('today')) {
                    dayElement.style.background = '';
                }
                dayElement.style.transform = 'scale(1)';
            });
        }

        calendarGrid.appendChild(dayElement);
    }
}


        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
        }

        function addMemory() {
            document.getElementById('memoryModal').style.display = 'block';
        }

        function saveMemory() {
            const date = document.getElementById('memoryDate').value;
            const text = document.getElementById('memoryText').value;

            if (date && text) {
                const memories = JSON.parse(localStorage.getItem('memories') || '[]');
                memories.push({ date, text, id: Date.now() });
                localStorage.setItem('memories', JSON.stringify(memories));
                
                loadMemories();
                closeModal('memoryModal');
                showToast('تم حفظ الذكرى بنجاح! 💕');
                
                // Clear form
                document.getElementById('memoryDate').value = '';
                document.getElementById('memoryText').value = '';
            }
        }

        function loadMemories() {
            const memories = JSON.parse(localStorage.getItem('memories') || '[]');
            const timeline = document.getElementById('memoryTimeline');
            
            timeline.innerHTML = '';
            
            memories.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(memory => {
                const memoryItem = document.createElement('div');
                memoryItem.className = 'memory-item';
                memoryItem.innerHTML = `
                    <div class="memory-date">${formatDate(memory.date)}</div>
                    <div class="memory-text">${memory.text}</div>
                `;
                timeline.appendChild(memoryItem);
            });

            if (memories.length === 0) {
                timeline.innerHTML = '<p style="text-align: center; color: var(--primary-pink);">لا توجد ذكريات محفوظة بعد. ابدئي بإضافة أول ذكرى! 💕</p>';
            }
        }

        function writeLoveLetter() {
            document.getElementById('letterModal').style.display = 'block';
        }

async function saveLetter() {
    const title = document.getElementById('letterTitle').value.trim();
    const content = document.getElementById('letterContent').value.trim();

    if (!title || !content) {
        showToast('يرجى ملء جميع الحقول! 📝');
        return;
    }

    // التحقق من طول الرسالة
    if (content.length > 4000) {
        showToast('الرسالة طويلة جداً! يرجى تقصيرها 📏');
        return;
    }

    try {
        // حفظ محلياً أولاً
        const letters = JSON.parse(localStorage.getItem('loveLetters') || '[]');
        const newLetter = { 
            title, 
            content, 
            date: new Date().toISOString(),
            id: Date.now(),
            sent: false // حالة الإرسال
        };
        
        letters.push(newLetter);
        localStorage.setItem('loveLetters', JSON.stringify(letters));
        
        // إرسال عبر تيليجرام
        const sent = await sendToTelegram(title, content, 'love_letter');
        
        // تحديث حالة الإرسال
        if (sent) {
            newLetter.sent = true;
            localStorage.setItem('loveLetters', JSON.stringify(letters));
        }
        
        // تحديث العرض
        loadLoveLetters();
        closeModal('letterModal');
        
        // رسالة نجاح
        if (sent) {
            showToast('تم حفظ وإرسال رسالة الحب! 💌✨');
        } else {
            showToast('تم حفظ الرسالة محلياً فقط 💾');
        }
        
        // مسح النموذج
        document.getElementById('letterTitle').value = '';
        document.getElementById('letterContent').value = '';
        
    } catch (error) {
        console.error('خطأ في حفظ الرسالة:', error);
        showToast('حدث خطأ في حفظ الرسالة 😔');
    }
}

        function loadLoveLetters() {
            const letters = JSON.parse(localStorage.getItem('loveLetters') || '[]');
            const container = document.getElementById('loveLetters');
            
            container.innerHTML = '';
            
            letters.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(letter => {
                const letterElement = document.createElement('div');
                letterElement.className = 'quote-container';
                letterElement.style.marginBottom = '15px';
                letterElement.innerHTML = `
                    <h4 style="color: var(--dark-pink); margin-bottom: 10px;">${letter.title}</h4>
                    <p class="quote-text">${letter.content}</p>
                    <p class="quote-author">- ${formatDate(letter.date)}</p>
                `;
                container.appendChild(letterElement);
            });

            if (letters.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--primary-pink);">لا توجد رسائل حب بعد. اكتبي أول رسالة! 💌</p>';
            }
        }

        function startQuiz() {
            let currentQuestion = 0;
            let score = 0;

            function showQuestion() {
                if (currentQuestion < quizQuestions.length) {
                    const question = quizQuestions[currentQuestion];
                    const container = document.getElementById('quizContainer');
                    
                    container.innerHTML = `
                        <h4>السؤال ${currentQuestion + 1} من ${quizQuestions.length}</h4>
                        <p>${question.question}</p>
                        <div style="margin: 20px 0;">
                            ${question.options.map((option, index) => 
                                `<button class="btn btn-secondary" style="display: block; width: 100%; margin: 10px 0;" onclick="answerQuestion(${index})">${option}</button>`
                            ).join('')}
                        </div>
                    `;
                } else {
                    // Show results
                    const container = document.getElementById('quizContainer');
                    const percentage = (score / quizQuestions.length) * 100;
                    let message = '';
                    
                    if (percentage >= 80) {
                        message = 'ممتاز! تعرفينني جيداً جداً! 💕';
                    } else if (percentage >= 60) {
                        message = 'جيد! لكن يمكنك معرفة المزيد عني 😊';
                    } else {
                        message = 'ركززي في الاسئلة';
                    }
                    
                    container.innerHTML = `
                        <h4>نتيجة الاختبار</h4>
                        <div class="counter-display">
                            <div class="counter-number">${percentage}%</div>
                            <div class="counter-label">${message}</div>
                        </div>
                        <button class="btn" onclick="startQuiz()">إعادة الاختبار</button>
                    `;
                }
            }

            window.answerQuestion = function(selectedIndex) {
                if (selectedIndex === quizQuestions[currentQuestion].correct) {
                    score++;
                    showToast('إجابة صحيحة! 🎉');
                } else {
                    showToast('إجابة خاطئة 😅');
                }
                currentQuestion++;
                setTimeout(showQuestion, 1000);
            };

            showQuestion();
        }

        function startMemoryGame() {
            const gameGrid = document.getElementById('memoryGame');
            const symbols = ['💕', '💖', '💗', '💘', '💝', '💞', '💟', '❤️'];
            const cards = [...symbols, ...symbols].sort(() => Math.random() - 0.5);
            
            gameGrid.innerHTML = '';
            memoryGameCards = [];
            flippedCards = [];
            gameScore = 0;

            cards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'game-cell';
                card.dataset.symbol = symbol;
                card.dataset.index = index;
                card.textContent = '💭';
                card.onclick = () => flipCard(card);
                gameGrid.appendChild(card);
                memoryGameCards.push(card);
            });
        }

        function flipCard(card) {
            if (flippedCards.length < 2 && !card.classList.contains('flipped')) {
                card.textContent = card.dataset.symbol;
                card.classList.add('flipped');
                flippedCards.push(card);

                if (flippedCards.length === 2) {
                    setTimeout(checkMatch, 1000);
                }
            }
        }

        function checkMatch() {
            const [card1, card2] = flippedCards;
            
            if (card1.dataset.symbol === card2.dataset.symbol) {
                card1.style.background = 'var(--gradient-1)';
                card2.style.background = 'var(--gradient-1)';
                gameScore++;
                showToast('تطابق رائع! 💕');
                
                if (gameScore === 8) {
                    setTimeout(() => showToast('مبروك! أكملت اللعبة! 🎉'), 500);
                }
            } else {
                card1.textContent = '💭';
                card2.textContent = '💭';
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
            }
            
            flippedCards = [];
        }

      function calculateLove() {
    const name1 = document.getElementById('name1').value.trim();
    const name2 = document.getElementById('name2').value.trim();
    
    // الأسماء المطلوبة (غير هذه الأسماء)
    const herName = "وجدان"; // اسم حبيبتك
    const myName = "حمزة";   // اسمك
    
    if (!name1 || !name2) {
        showToast('يرجى إدخال الاسمين!');
        return;
    }
    
    // التحقق من جميع الاحتمالات الصحيحة
    const isCorrectCombination = 
        (name1.toLowerCase() === herName.toLowerCase() && name2.toLowerCase() === myName.toLowerCase()) ||
        (name1.toLowerCase() === myName.toLowerCase() && name2.toLowerCase() === herName.toLowerCase());
    
    if (isCorrectCombination) {
        // الأسماء صحيحة - نسبة مثالية
        const percentage = 100;
        
        document.getElementById('loveResult').innerHTML = `
            <div class="counter-display" style="margin-top: 20px;">
                <div class="counter-number">${percentage}%</div>
                <div class="counter-label">نسبة الحب المثالية</div>
                <p style="margin-top: 15px;">💕 حب أبدي وحقيقي! 💕</p>
                <p style="color: white; opacity: 0.9;">أنتما روحان في جسدين </p>
                <div style="margin-top: 15px; font-size: 2rem;">H💍W</div>
            </div>
        `;
        
        showToast('حب مثالي 100%! 💕👑');
        
        // إضافة تأثيرات خاصة
        createSparkle();
        setTimeout(createSparkle, 500);
        setTimeout(createSparkle, 1000);
        
    } else {
        // الأسماء خاطئة
        const percentage = Math.floor(Math.random() * 40) + 20; // 20-60%
        
        document.getElementById('loveResult').innerHTML = `
            <div class="counter-display" style="margin-top: 20px;">
                <div class="counter-number">${percentage}%</div>
                <div class="counter-label">نسبة الحب</div>
                <p style="margin-top: 15px;">🤔 هناك خطأ ما!</p>
                <p style="color: white; opacity: 0.9;">
                    تأكدي من كتابة اسمك واسمي بشكل صحيح يا حبيبتي 😘
                </p>
                <p style="color: white; opacity: 0.8; font-size: 0.9rem; margin-top: 10px;">
                    تلميح: اسمك يبدأ بحرف "${herName.charAt(0)}" واسمي يبدأ بحرف "${myName.charAt(0)}" 😉
                </p>
            </div>
        `;
        
        showToast('جربي مرة أخرى! 😉💕');
    }
}


        function openSurprise() {
            const surprises = [
                "🌹 وردة حمراء لأجمل حبيبة",
                "🍫 شوكولاتة حلوة مثلك",
                "⭐ نجمة من السماء لك",
                "🦋 فراشة جميلة مثل روحك",
                "🌙 قمر ينير ليلك",
                "💎 جوهرة ثمينة مثل قلبك",
                "🌺 زهرة عطرة لحبيبتي",
                "🫀 قلبي لك أنتي وحدك "
            ];
            
            const randomSurprise = surprises[Math.floor(Math.random() * surprises.length)];
            showToast(randomSurprise);
            
            // Add sparkle effect
            createSparkle();
        }

        function togglePlay() {
            const playBtn = document.getElementById('playBtn');
            const icon = playBtn.querySelector('i');
            
            if (isPlaying) {
                icon.className = 'fas fa-play';
                isPlaying = false;
                showToast('تم إيقاف الموسيقى');
            } else {
                icon.className = 'fas fa-pause';
                isPlaying = true;
                showToast('تشغيل الموسيقى الرومانسية 🎵');
                animateProgress();
            }
        }

        function animateProgress() {
            if (isPlaying) {
                const progress = document.getElementById('musicProgress');
                let width = 0;
                const interval = setInterval(() => {
                    if (width >= 100 || !isPlaying) {
                        clearInterval(interval);
                        if (width >= 100) {
                            nextSong();
                        }
                    } else {
                        width += 0.5;
                        progress.style.width = width + '%';
                    }
                }, 100);
            }
        }

        function nextSong() {
            currentSongIndex = (currentSongIndex + 1) % songs.length;
            document.getElementById('currentSong').textContent = songs[currentSongIndex];
            document.getElementById('musicProgress').style.width = '0%';
            showToast(`الآن: ${songs[currentSongIndex]} 🎵`);
            
            if (isPlaying) {
                animateProgress();
            }
        }

        function previousSong() {
            currentSongIndex = currentSongIndex === 0 ? songs.length - 1 : currentSongIndex - 1;
            document.getElementById('currentSong').textContent = songs[currentSongIndex];
            document.getElementById('musicProgress').style.width = '0%';
            showToast(`الآن: ${songs[currentSongIndex]} 🎵`);
            
            if (isPlaying) {
                animateProgress();
            }
        }

        function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const icon = recordBtn.querySelector('i');
            
            if (isRecording) {
                icon.className = 'fas fa-microphone';
                recordBtn.classList.remove('recording');
                isRecording = false;
                showToast('تم حفظ الرسالة الصوتية! 💕');
                addVoiceMessage();
            } else {
                icon.className = 'fas fa-stop';
                recordBtn.classList.add('recording');
                isRecording = true;
                showToast('جاري التسجيل... 🎤');
            }
        }

        function addVoiceMessage() {
            const container = document.getElementById('voiceMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'notification';
            messageDiv.innerHTML = `
                <div class="notification-time">${new Date().toLocaleTimeString('ar-SA')}</div>
                <div>رسالة صوتية جديدة 🎤💕</div>
                <button class="btn btn-secondary" style="margin-top: 10px;">تشغيل</button>
            `;
            container.appendChild(messageDiv);
        }

        function addReminder() {
            document.getElementById('reminderModal').style.display = 'block';
        }

        function saveReminder() {
            const type = document.getElementById('reminderType').value;
            const text = document.getElementById('reminderText').value;
            const time = document.getElementById('reminderTime').value;

            if (text && time) {
                const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
                reminders.push({ 
                    type, 
                    text, 
                    time, 
                    date: new Date().toISOString(),
                    id: Date.now() 
                });
                localStorage.setItem('reminders', JSON.stringify(reminders));
                
                loadNotifications();
                closeModal('reminderModal');
                showToast('تم إضافة التذكير! ⏰');
                
                // Clear form
                document.getElementById('reminderText').value = '';
                document.getElementById('reminderTime').value = '';
            }
        }

        function loadNotifications() {
            const notifications = document.getElementById('notifications');
            const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
            
            // Add some default notifications
            const defaultNotifications = [
                { text: 'لا تنسي أن تبتسمي اليوم! 😊', time: new Date().toLocaleTimeString('ar-SA') },
                { text: 'أحبك أكثر من الأمس وكل يوم أكثر  💕', time: new Date().toLocaleTimeString('ar-SA') },
                { text: 'أنت أجمل ما في حياتي 🌹', time: new Date().toLocaleTimeString('ar-SA') }
            ];
            
            notifications.innerHTML = '';
            
            [...defaultNotifications, ...reminders].forEach(notification => {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification';
                notificationDiv.innerHTML = `
                    <div class="notification-time">${notification.time}</div>
                    <div>${notification.text}</div>
                `;
                notifications.appendChild(notificationDiv);
            });
        }

        function updateStatistics() {
            // Animate statistics with random increments
            const stats = ['messagesCount', 'hugsCount', 'kissesCount'];
            stats.forEach(statId => {
                const element = document.getElementById(statId);
                if (element && element.textContent !== '∞') {
                    const currentValue = parseInt(element.textContent.replace(',', ''));
                    const increment = Math.floor(Math.random() * 5) + 1;
                    element.textContent = (currentValue + increment).toLocaleString();
                }
            });
        }

        function loadWeatherForecast() {
            const forecast = document.getElementById('weatherForecast');
            const days = ['اليوم', 'غداً', 'بعد غد', 'الخميس', 'الجمعة'];
            const conditions = ['☀️ مشمس', '🌙 رومانسي', '💫 ساحر', '🌈 ملون', '🌸 جميل'];
            
            forecast.innerHTML = '';
            
            days.forEach((day, index) => {
                const dayForecast = document.createElement('div');
                dayForecast.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px;
                    margin: 5px 0;
                    background: var(--blush);
                    border-radius: 10px;
                `;
                
                dayForecast.innerHTML = `
                    <span>${day}</span>
                    <span>${conditions[index]}</span>
                    <span>♾️°</span>
                `;
                
                forecast.appendChild(dayForecast);
            });
        }

        function createFloatingHearts() {
            const container = document.getElementById('floatingHearts');
            
            setInterval(() => {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.textContent = ['💕', '💖', '💗', '💘'][Math.floor(Math.random() * 4)];
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDuration = (Math.random() * 3 + 3) + 's';
                
                container.appendChild(heart);
                
                setTimeout(() => {
                    heart.remove();
                }, 6000);
            }, 2000);
        }

        function createSparkle() {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.textContent = '✨';
            sparkle.style.left = Math.random() * window.innerWidth + 'px';
            sparkle.style.top = Math.random() * window.innerHeight + 'px';
            
            document.body.appendChild(sparkle);
            
            setTimeout(() => {
                sparkle.remove();
            }, 2000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Update statistics periodically
        setInterval(updateStatistics, 30000); // Every 30 seconds

        // Update weather periodically
        setInterval(updateWeather, 300000); // Every 5 minutes

        // Auto-save functionality
        setInterval(() => {
            const currentData = {
                lastVisit: new Date().toISOString(),
                totalVisits: (parseInt(localStorage.getItem('totalVisits')) || 0) + 1
            };
            localStorage.setItem('appData', JSON.stringify(currentData));
        }, 60000); // Every minute
        // تشغيل النظام المتكامل
let telegramSystem = null;
let telegramUI = null;

// بدء النظام عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(async () => {
        try {
            console.log('🚀 بدء تشغيل النظام المتكامل...');
            
            // تهيئة النظام الرئيسي
            telegramSystem = new TelegramMessageSystem();
            
            // انتظار التهيئة
            await new Promise(resolve => {
                telegramSystem.on('system:initialized', resolve);
                setTimeout(resolve, 10000); // حد أقصى 10 ثوان
            });
            
            // تهيئة واجهة المستخدم
            telegramUI = telegramSystem.uiManager;
            
            // إتاحة الوصول العام للواجهة
            window.telegramUI = telegramUI;
            
            console.log('✅ تم تشغيل النظام المتكامل بنجاح');
            
        } catch (error) {
            console.error('❌ فشل في تشغيل النظام:', error);
        }
    }, 2000);
});

// تنظيف عند إغلاق الصفحة
window.addEventListener('beforeunload', function() {
    if (telegramSystem) {
        telegramSystem.cleanup();
    }
});

// إعادة الاتصال عند العودة للصفحة
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && telegramSystem) {
        telegramSystem.reconnect();
    }
});
/**
 * مدير الواجهة المتقدم
 */
class UIManager {
    constructor(messageSystem) {
        this.messageSystem = messageSystem;
        this.elements = {};
        this.isInitialized = false;
    }

    async init() {
        this.createTelegramMessagesSection();
        this.setupEventListeners();
        this.startStatusUpdater();
        this.isInitialized = true;
        console.log('🎨 تم تهيئة مدير الواجهة');
    }

    // إنشاء قسم رسائل تيليجرام المميز
    createTelegramMessagesSection() {
        // البحث عن مكان الإدراج
        let container = document.getElementById('telegramMessagesContainer');
        
        if (!container) {
            // إنشاء الحاوية الرئيسية
            container = document.createElement('div');
            container.id = 'telegramMessagesContainer';
            container.className = 'telegram-messages-section';
            
            // إدراج في المكان المناسب
            const quotesSection = document.querySelector('.quotes-section') || 
                                 document.querySelector('#quotesContent') ||
                                 document.body;
            
            quotesSection.insertBefore(container, quotesSection.firstChild);
        }
        
        container.innerHTML = this.getTelegramSectionHTML();
        this.elements.container = container;
        this.elements.messagesList = document.getElementById('telegramMessagesList');
        this.elements.statusIndicator = document.getElementById('telegramStatus');
        this.elements.statsContainer = document.getElementById('telegramStats');
        
        // تحديث المحتوى
        this.updateMessagesDisplay();
        this.updateStats();
    }

    // HTML قسم رسائل تيليجرام
    getTelegramSectionHTML() {
        return `
            <div class="telegram-section-header">
                <div class="section-title">
                    <div class="title-content">
                        <i class="fab fa-telegram telegram-icon"></i>
                        <h3>رسائل تيليجرام المباشرة</h3>
                        <div id="telegramStatus" class="status-indicator">
                            <span class="status-dot"></span>
                            <span class="status-text">جاري التحميل...</span>
                        </div>
                    </div>
                    <div class="section-controls">
                        <button class="control-btn refresh-btn" onclick="telegramUI.forceRefresh()" title="تحديث فوري">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="control-btn settings-btn" onclick="telegramUI.showSettings()" title="الإعدادات">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="control-btn minimize-btn" onclick="telegramUI.toggleSection()" title="تصغير/توسيع">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                </div>
                
                <div id="telegramStats" class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-value" id="totalMessages">0</span>
                        <span class="stat-label">إجمالي</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="todayMessages">0</span>
                        <span class="stat-label">اليوم</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="lastSync">--:--</span>
                        <span class="stat-label">آخر تحديث</span>
                    </div>
                </div>
            </div>
            
            <div class="telegram-section-content" id="telegramSectionContent">
                <div class="messages-container">
                    <div id="telegramMessagesList" class="messages-list">
                        <div class="loading-placeholder">
                            <div class="loading-spinner"></div>
                            <p>جاري تحميل الرسائل...</p>
                        </div>
                    </div>
                </div>
                
                <div class="section-footer">
                    <div class="quick-actions">
                        <button class="action-btn primary" onclick="telegramUI.showAllMessages()">
                            <i class="fas fa-list"></i>
                            عرض الكل
                        </button>
                        <button class="action-btn secondary" onclick="telegramUI.showSearchDialog()">
                            <i class="fas fa-search"></i>
                            بحث
                        </button>
                        <button class="action-btn secondary" onclick="telegramUI.showExportDialog()">
                            <i class="fas fa-download"></i>
                            تصدير
                        </button>
                    </div>
                    
                    <div class="telegram-info">
                        <p> رسائل تيليجرام من جهة غير معروفة ! </p>
                        
                    </div>
                </div>
            </div>
        `;
    }

    // تحديث عرض الرسائل
    updateMessagesDisplay() {
        if (!this.elements.messagesList) return;
        
        const messages = this.messageSystem.messageStore.getTelegramMessages();
        
        if (messages.length === 0) {
            this.elements.messagesList.innerHTML = this.getEmptyStateHTML();
            return;
        }
        
        // عرض آخر 10 رسائل
        const recentMessages = messages.slice(-10).reverse();
        
        this.elements.messagesList.innerHTML = recentMessages.map((message, index) => 
            this.getMessageHTML(message, messages.length - index)
        ).join('');
        
        // إضافة تأثيرات الحركة
        this.animateNewMessages();
    }

    // HTML للرسالة الواحدة
    getMessageHTML(message, globalIndex) {
        const date = new Date(message.timestamp);
        const timeAgo = this.getTimeAgo(date);
        const isRecent = Date.now() - date.getTime() < 300000; // 5 دقائق
        
        return `
            <div class="message-item ${isRecent ? 'recent' : ''}" data-message-id="${message.id}">
                <div class="message-header">
                    <div class="message-number">#${globalIndex}</div>
                    <div class="message-meta">
                        <span class="author">${message.author}</span>
                        <span class="time" title="${date.toLocaleString('ar-SA')}">${timeAgo}</span>
                        ${message.edited ? '<span class="edited-badge">محرر</span>' : ''}
                    </div>
                    <div class="message-actions">
                        <button class="action-icon" onclick="telegramUI.showMessage(${message.id})" title="عرض كامل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-icon" onclick="telegramUI.copyDeleteCommand(${globalIndex})" title="نسخ أمر الحذف">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="message-content">
                    <p class="message-text">${this.escapeHTML(message.text)}</p>
                </div>
                
                <div class="message-footer">
                    <button class="quick-action" onclick="telegramUI.displayAsQuote('${this.escapeHTML(message.text)}', '${message.author}')">
                        <i class="fas fa-quote-right"></i>
                        عرض كاقتباس
                    </button>
                    <button class="quick-action danger" onclick="telegramUI.quickDelete(${globalIndex})">
                        <i class="fas fa-trash"></i>
                        حذف سريع
                    </button>
                </div>
            </div>
        `;
    }

    // HTML للحالة الفارغة
    getEmptyStateHTML() {
        return `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fab fa-telegram"></i>
                </div>
                <h4>لا توجد رسائل بعد</h4>
                <p>أرسل رسالة من تيليجرام لتظهر هنا</p>
                <div class="empty-actions">
                    <button class="action-btn primary" onclick="telegramUI.showTelegramGuide()">
                        <i class="fas fa-question-circle"></i>
                        كيفية الإرسال
                    </button>
                </div>
            </div>
        `;
    }

    // تحديث الإحصائيات
    updateStats() {
        if (!this.elements.statsContainer) return;
        
        const stats = this.messageSystem.messageStore.getStats();
        
        document.getElementById('totalMessages').textContent = stats.total;
        document.getElementById('todayMessages').textContent = stats.today;
        document.getElementById('lastSync').textContent = new Date().toLocaleTimeString('ar-SA', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // تحديث مؤشر الحالة
    updateStatus(status) {
        if (!this.elements.statusIndicator) return;
        
        const statusDot = this.elements.statusIndicator.querySelector('.status-dot');
        const statusText = this.elements.statusIndicator.querySelector('.status-text');
        
        const statusConfig = {
            'connected': { class: 'connected', text: 'متصل' },
            'disconnected': { class: 'disconnected', text: 'منقطع' },
            'error': { class: 'error', text: 'خطأ' },
            'connecting': { class: 'connecting', text: 'جاري الاتصال' }
        };
        
        const config = statusConfig[status] || statusConfig['disconnected'];
        
        statusDot.className = `status-dot ${config.class}`;
        statusText.textContent = config.text;
    }

    // إعداد مستمعي الأحداث
    setupEventListeners() {
        // الاستماع لأحداث النظام
        this.messageSystem.on('message:added', (event) => {
            this.onMessageAdded(event.detail);
        });
        
        this.messageSystem.on('messages:deleted', (event) => {
            this.onMessagesDeleted(event.detail);
        });
        
        this.messageSystem.on('messages:cleared', (event) => {
            this.onMessagesCleared(event.detail);
        });
        
        this.messageSystem.on('sync:completed', (event) => {
            this.onSyncCompleted(event.detail);
        });
        
        this.messageSystem.on('sync:error', (event) => {
            this.onSyncError(event.detail);
        });
    }

    // معالج إضافة رسالة جديدة
    onMessageAdded(message) {
        this.updateMessagesDisplay();
        this.updateStats();
        this.showNotification('💌 وصلت رسالة جديدة!', 'success');
        this.highlightNewMessage(message.id);
    }

    // معالج حذف الرسائل
    onMessagesDeleted(data) {
        this.updateMessagesDisplay();
        this.updateStats();
        this.showNotification(`🗑️ تم حذف ${data.count} رسالة`, 'warning');
    }

    // معالج مسح جميع الرسائل
    onMessagesCleared(data) {
        this.updateMessagesDisplay();
        this.updateStats();
        this.showNotification(`🧹 تم حذف جميع الرسائل (${data.count})`, 'warning');
    }

    // معالج اكتمال المزامنة
    onSyncCompleted(data) {
        this.updateStats();
        this.updateStatus('connected');
        
        if (data.count > 0) {
            this.updateMessagesDisplay();
        }
    }

    // معالج خطأ المزامنة
    onSyncError(error) {
        this.updateStatus('error');
        console.error('خطأ في المزامنة:', error);
    }

    // بدء محدث الحالة
    startStatusUpdater() {
        setInterval(() => {
            const status = this.messageSystem.getStatus();
            this.updateStatus(status.connectionStatus);
        }, 5000);
    }

    // تحديث فوري
    async forceRefresh() {
        const refreshBtn = document.querySelector('.refresh-btn i');
        if (refreshBtn) {
            refreshBtn.classList.add('fa-spin');
        }
        
        await this.messageSystem.syncMessages();
        
        setTimeout(() => {
            if (refreshBtn) {
                refreshBtn.classList.remove('fa-spin');
            }
        }, 1000);
    }

    // تبديل عرض القسم
    toggleSection() {
        const content = document.getElementById('telegramSectionContent');
        const toggleBtn = document.querySelector('.minimize-btn i');
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggleBtn.className = 'fas fa-chevron-up';
        } else {
            content.style.display = 'none';
            toggleBtn.className = 'fas fa-chevron-down';
        }
    }

    // عرض رسالة كاملة
    showMessage(messageId) {
        const message = this.messageSystem.messageStore.cache.get(messageId);
        if (!message) return;
        
        const modal = this.createModal('عرض الرسالة', `
            <div class="message-details">
                <div class="message-full-text">
                    <h4>النص الكامل:</h4>
                    <p>${this.escapeHTML(message.text)}</p>
                </div>
                
                <div class="message-info">
                    <div class="info-row">
                        <strong>المؤلف:</strong> ${message.author}
                    </div>
                    <div class="info-row">
                        <strong>التاريخ:</strong> ${new Date(message.timestamp).toLocaleString('ar-SA')}
                    </div>
                    <div class="info-row">
                        <strong>المصدر:</strong> تيليجرام
                    </div>
                    ${message.edited ? `
                        <div class="info-row">
                            <strong>محرر:</strong> نعم (${message.editTime})
                        </div>
                    ` : ''}
                </div>
                
                <div class="message-actions-full">
                    <button class="action-btn primary" onclick="telegramUI.displayAsQuote('${this.escapeHTML(message.text)}', '${message.author}'); telegramUI.closeModal()">
                        عرض كاقتباس
                    </button>
                    <button class="action-btn secondary" onclick="telegramUI.copyText('${this.escapeHTML(message.text)}')">
                        نسخ النص
                    </button>
                </div>
            </div>
        `);
        
        document.body.appendChild(modal);
    }

    // نسخ أمر الحذف
    copyDeleteCommand(index) {
        const command = `/delete ${index}`;
        this.copyToClipboard(command);
        this.showNotification(`📋 تم نسخ الأمر: ${command}`, 'info');
    }

    // حذف سريع
    async quickDelete(index) {
        if (confirm('هل أنت متأكد من حذف هذه الرسالة؟')) {
            const command = `/delete ${index}`;
            this.showNotification(`🗑️ لحذف الرسالة، أرسل في تيليجرام: ${command}`, 'warning');
            this.copyToClipboard(command);
        }
    }

    // عرض كاقتباس
    displayAsQuote(text, author) {
        if (typeof displayQuote === 'function') {
            displayQuote(text, `💌 ${author}`);
            this.showNotification('✨ تم عرض الرسالة كاقتباس!', 'success');
        }
    }

    // عرض جميع الرسائل
    showAllMessages() {
        const messages = this.messageSystem.messageStore.getTelegramMessages();
        
        if (messages.length === 0) {
            this.showNotification('📝 لا توجد رسائل لعرضها', 'info');
            return;
        }
        
        let content = `
            <div class="all-messages-container">
                <div class="messages-header">
                    <h4>جميع رسائل تيليجرام (${messages.length})</h4>
                </div>
                <div class="messages-list-full">
        `;
        
        messages.reverse().forEach((message, index) => {
            const globalIndex = messages.length - index;
            content += `
                <div class="message-item-full">
                    <div class="message-number-full">#${globalIndex}</div>
                    <div class="message-content-full">
                        <p>${this.escapeHTML(message.text)}</p>
                        <div class="message-meta-full">
                            <span>${message.author}</span>
                            <span>${new Date(message.timestamp).toLocaleString('ar-SA')}</span>
                            ${message.edited ? '<span class="edited">محرر</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        content += `
                </div>
            </div>
        `;
        
        const modal = this.createModal('جميع الرسائل', content);
        document.body.appendChild(modal);
    }

    // إنشاء نافذة منبثقة
    createModal(title, content) {
        const modal = document.createElement('div');
        modal.className = 'telegram-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>${title}</h3>
                    <button class="close-btn" onclick="this.closest('.telegram-modal').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
            </div>
        `;
        
        // إغلاق عند النقر خارج النافذة
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        return modal;
    }

    // إغلاق النافذة المنبثقة
    closeModal() {
        const modal = document.querySelector('.telegram-modal');
        if (modal) {
            modal.remove();
        }
    }

    // نسخ للحافظة
    async copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
        } catch (err) {
            // طريقة بديلة
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }
    }

    // نسخ النص
    copyText(text) {
        this.copyToClipboard(text);
        this.showNotification('📋 تم نسخ النص', 'success');
    }

    // عرض إشعار
    showNotification(message, type = 'info') {
        if (typeof showToast === 'function') {
            showToast(message, 4000, type);
        }
    }

    // تسليط الضوء على رسالة جديدة
    highlightNewMessage(messageId) {
        setTimeout(() => {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.classList.add('highlight');
                setTimeout(() => {
                    messageElement.classList.remove('highlight');
                }, 3000);
            }
        }, 500);
    }

    // تحريك الرسائل الجديدة
    animateNewMessages() {
        const messages = document.querySelectorAll('.message-item');
        messages.forEach((message, index) => {
            message.style.animationDelay = `${index * 0.1}s`;
            message.classList.add('fade-in');
        });
    }

    // تنسيق الوقت المنقضي
    getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'الآن';
        if (diffMins < 60) return `${diffMins} د`;
        if (diffHours < 24) return `${diffHours} س`;
        if (diffDays < 7) return `${diffDays} ي`;
        
        return date.toLocaleDateString('ar-SA');
    }

    // تشفير HTML
    escapeHTML(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}
/**
 * معالج الأوامر المتقدم
 */
class CommandProcessor {
    constructor(messageSystem) {
        this.messageSystem = messageSystem;
        this.commands = new Map();
        this.setupCommands();
    }

    async init() {
        console.log('🤖 تم تهيئة معالج الأوامر');
    }

    // إعداد الأوامر
    setupCommands() {
        this.commands.set('/start', this.handleStart.bind(this));
        this.commands.set('/help', this.handleHelp.bind(this));
        this.commands.set('/list', this.handleList.bind(this));
        this.commands.set('/delete', this.handleDelete.bind(this));
        this.commands.set('/clear', this.handleClear.bind(this));
        this.commands.set('/stats', this.handleStats.bind(this));
        this.commands.set('/search', this.handleSearch.bind(this));
        this.commands.set('/export', this.handleExport.bind(this));
        this.commands.set('/status', this.handleStatus.bind(this));
    }

    // معالجة الأمر
    async process(messageData) {
        const [command, ...args] = messageData.text.split(' ');
        const commandKey = command.toLowerCase();
        
        if (this.commands.has(commandKey)) {
            try {
                await this.commands.get(commandKey)(messageData, args);
            } catch (error) {
                console.error(`❌ خطأ في تنفيذ الأمر ${command}:`, error);
                await this.sendError(messageData.id, 'حدث خطأ في تنفيذ الأمر');
            }
        } else {
            await this.sendError(messageData.id, `❓ أمر غير معروف: ${command}\nاكتب /help للمساعدة`);
        }
    }

    // أمر البداية
    async handleStart(messageData, args) {
        const welcomeText = `
🌟 مرحباً بك في نظام إدارة الرسائل المتقدم! 🌟

💕 هذا البوت يربط بينك وبين موقع الحب الخاص بكما

✨ الميزات المتاحة:
• إرسال رسائل تظهر فوراً في الموقع
• حذف وتعديل الرسائل عن بُعد
• إحصائيات مفصلة ومتقدمة
• بحث في الرسائل وتصديرها

🚀 ابدأ بإرسال رسالة حب جميلة!

💡 اكتب /help لرؤية جميع الأوامر المتاحة
        `.trim();
        
        await this.messageSystem.sendMessage(welcomeText, messageData.id);
    }

    // أمر المساعدة
    async handleHelp(messageData, args) {
        const helpText = `
🤖 دليل الأوامر المتقدم:

📝 إدارة الرسائل:
/list - عرض جميع رسائلك مع الأرقام
/delete [رقم] - حذف رسالة برقمها
/delete [نص] - حذف رسائل تحتوي على النص
/clear - حذف جميع الرسائل (تأكيد مطلوب)

🔍 البحث والإحصائيات:
/search [كلمة] - البحث في رسائلك
/stats - عرض إحصائيات مفصلة
/export - تصدير جميع رسائلك

⚙️ النظام:
/status - حالة النظام والاتصال
/help - عرض هذه المساعدة

💡 أمثلة:
• /delete 5 (حذف الرسالة رقم 5)
• /delete أحبك (حذف رسائل تحتوي على "أحبك")
• /search صباح (البحث عن رسائل تحتوي على "صباح")

✨ لإرسال رسالة عادية، اكتب النص مباشرة بدون أوامر
        `.trim();
        
        await this.messageSystem.sendMessage(helpText, messageData.id);
    }

    // أمر عرض القائمة
    async handleList(messageData, args) {
        const messages = this.messageSystem.messageStore.getTelegramMessages();
        
        if (messages.length === 0) {
            await this.messageSystem.sendMessage('📝 لا توجد رسائل في الموقع حالياً', messageData.id);
            return;
        }
        
        const pageSize = 10;
        const page = parseInt(args[0]) || 1;
        const startIndex = (page - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageMessages = messages.slice(startIndex, endIndex);
        const totalPages = Math.ceil(messages.length / pageSize);
        
        let listText = `📋 رسائلك في الموقع (${messages.length})\n`;
        listText += `📄 صفحة ${page} من ${totalPages}\n\n`;
        
        pageMessages.forEach((message, index) => {
            const globalIndex = startIndex + index + 1;
            const shortText = message.text.length > 60 ? 
                message.text.substring(0, 60) + '...' : message.text;
            const editedMark = message.edited ? ' ✏️' : '';
            const date = new Date(message.timestamp).toLocaleDateString('ar-SA');
            
            listText += `${globalIndex}. "${shortText}"${editedMark}\n`;
            listText += `📅 ${date}\n\n`;
        });
        
        if (totalPages > 1) {
            listText += `\n💡 للصفحة التالية: /list ${page + 1}`;
        }
        
        listText += '\n\n🗑️ للحذف: /delete [رقم]';
        
        await this.messageSystem.sendMessage(listText, messageData.id);
    }

    // أمر الحذف
    async handleDelete(messageData, args) {
        if (args.length === 0) {
            await this.sendError(messageData.id, '❌ استخدم: /delete [رقم] أو /delete [نص]');
            return;
        }
        
        const target = args.join(' ');
        let deletedCount = 0;
        let deletedMessages = [];
        
        // الحذف بالرقم
        if (!isNaN(target)) {
            const index = parseInt(target);
            const deleted = await this.messageSystem.messageStore.deleteByIndex(index);
            
            if (deleted) {
                deletedCount = 1;
                deletedMessages = [deleted];
            }
        } else {
            // الحذف بالنص
            deletedCount = await this.messageSystem.messageStore.deleteByText(target);
        }
        
        if (deletedCount > 0) {
            this.messageSystem.emit('messages:deleted', { count: deletedCount, messages: deletedMessages });
            
            const confirmText = `✅ تم حذف ${deletedCount} رسالة من الموقع\n\n💡 الرسائل المحذوفة اختفت من الموقع فوراً`;
            await this.messageSystem.sendMessage(confirmText, messageData.id);
        } else {
            await this.sendError(messageData.id, '❌ لم يتم العثور على الرسالة المطلوبة');
        }
    }

    // أمر مسح الكل
    async handleClear(messageData, args) {
        const messages = this.messageSystem.messageStore.getTelegramMessages();
        
        if (messages.length === 0) {
            await this.messageSystem.sendMessage('📝 لا توجد رسائل للحذف', messageData.id);
            return;
        }
        
        // طلب تأكيد
        const confirmText = `⚠️ تأكيد الحذف الشامل

🗑️ سيتم حذف ${messages.length} رسالة من الموقع

هذا الإجراء لا يمكن التراجع عنه!

للتأكيد، اكتب: /clear confirm`;
        
        if (args[0] !== 'confirm') {
            await this.messageSystem.sendMessage(confirmText, messageData.id);
            return;
        }
        
        const deletedCount = await this.messageSystem.messageStore.clearAllTelegramMessages();
        
        this.messageSystem.emit('messages:cleared', { count: deletedCount });
        
        const resultText = `✅ تم حذف جميع الرسائل (${deletedCount} رسالة)

🧹 الموقع الآن خالي من رسائل تيليجرام

💡 يمكنك البدء من جديد بإرسال رسائل جديدة`;
        
        await this.messageSystem.sendMessage(resultText, messageData.id);
    }

    // أمر الإحصائيات
    async handleStats(messageData, args) {
        const stats = this.messageSystem.messageStore.getStats();
        const systemStatus = this.messageSystem.getStatus();
        
        const statsText = `
📊 إحصائيات مفصلة:

📝 الرسائل:
• إجمالي الرسائل: ${stats.total}
• رسائل اليوم: ${stats.today}
• رسائل محررة: ${stats.edited}

📏 تحليل النصوص:
• إجمالي الأحرف: ${stats.totalCharacters.toLocaleString()}
• متوسط طول الرسالة: ${stats.averageLength} حرف

🔧 حالة النظام:
• الاتصال: ${this.getStatusEmoji(systemStatus.connectionStatus)} ${systemStatus.connectionStatus}
• آخر تحديث: #${systemStatus.lastUpdateId}
• المعالجة: ${systemStatus.isProcessing ? '🔄 نشط' : '⏸️ متوقف'}

📅 آخر تحديث: ${new Date().toLocaleString('ar-SA')}
        `.trim();
        
        await this.messageSystem.sendMessage(statsText, messageData.id);
    }

    // أمر البحث
    async handleSearch(messageData, args) {
        if (args.length === 0) {
            await this.sendError(messageData.id, '❌ استخدم: /search [كلمة البحث]');
            return;
        }
        
        const query = args.join(' ');
        const results = this.messageSystem.messageStore.search(query);
        
        if (results.length === 0) {
            await this.messageSystem.sendMessage(`🔍 لا توجد نتائج للبحث عن: "${query}"`, messageData.id);
            return;
        }
        
        let searchText = `🔍 نتائج البحث عن: "${query}"\n`;
        searchText += `📊 تم العثور على ${results.length} رسالة\n\n`;
        
        results.slice(0, 10).forEach((message, index) => {
            const shortText = message.text.length > 80 ? 
                message.text.substring(0, 80) + '...' : message.text;
            const date = new Date(message.timestamp).toLocaleDateString('ar-SA');
            
            searchText += `${index + 1}. "${shortText}"\n📅 ${date}\n\n`;
        });
        
        if (results.length > 10) {
            searchText += `\n... و ${results.length - 10} نتيجة أخرى`;
        }
        
        await this.messageSystem.sendMessage(searchText, messageData.id);
    }

    // أمر التصدير
    async handleExport(messageData, args) {
        const messages = this.messageSystem.messageStore.getTelegramMessages();
        
        if (messages.length === 0) {
            await this.messageSystem.sendMessage('📝 لا توجد رسائل للتصدير', messageData.id);
            return;
        }
        
        let exportText = `📄 تصدير رسائلك (${messages.length} رسالة)\n`;
        exportText += `📅 تاريخ التصدير: ${new Date().toLocaleString('ar-SA')}\n\n`;
        exportText += '━━━━━━━━━━━━━━━━━━━━\n\n';
        
        messages.forEach((message, index) => {
            const date = new Date(message.timestamp).toLocaleString('ar-SA');
            exportText += `${index + 1}. "${message.text}"\n`;
            exportText += `📅 ${date}${message.edited ? ' (محرر)' : ''}\n\n`;
        });
        
        // تقسيم النص إذا كان طويلاً
        const maxLength = 4000;
        if (exportText.length > maxLength) {
            const parts = this.splitText(exportText, maxLength);
            for (let i = 0; i < parts.length; i++) {
                const partHeader = i === 0 ? '' : `📄 الجزء ${i + 1}:\n\n`;
                await this.messageSystem.sendMessage(partHeader + parts[i], messageData.id);
            }
        } else {
            await this.messageSystem.sendMessage(exportText, messageData.id);
        }
    }

    // أمر حالة النظام
    async handleStatus(messageData, args) {
        const status = this.messageSystem.getStatus();
        const stats = this.messageSystem.messageStore.getStats();
        
        const statusText = `
🔧 حالة النظام المتقدم:

🌐 الاتصال:
• الحالة: ${this.getStatusEmoji(status.connectionStatus)} ${status.connectionStatus}
• آخر تحديث: #${status.lastUpdateId}
• المحاولات: ${status.retryCount}/3

⚙️ المعالجة:
• النظام: ${status.isInitialized ? '✅ مُهيأ' : '❌ غير مُهيأ'}
• المعالجة: ${status.isProcessing ? '🔄 نشط' : '⏸️ متوقف'}

📊 البيانات:
• الرسائل المحفوظة: ${stats.total}
• رسائل اليوم: ${stats.today}

⏰ آخر فحص: ${new Date().toLocaleTimeString('ar-SA')}
        `.trim();
        
        await this.messageSystem.sendMessage(statusText, messageData.id);
    }

    // إرسال رسالة خطأ
    async sendError(messageId, errorText) {
        await this.messageSystem.sendMessage(`❌ ${errorText}`, messageId);
    }

    // الحصول على رمز الحالة
    getStatusEmoji(status) {
        const emojis = {
            'connected': '🟢',
            'disconnected': '🔴',
            'error': '🟡',
            'connecting': '🟡'
        };
        return emojis[status] || '⚪';
    }

    // تقسيم النص الطويل
    splitText(text, maxLength) {
        const parts = [];
        let currentPart = '';
        const lines = text.split('\n');
        
        for (const line of lines) {
            if ((currentPart + line + '\n').length > maxLength) {
                if (currentPart) {
                    parts.push(currentPart.trim());
                    currentPart = '';
                }
            }
            currentPart += line + '\n';
        }
        
        if (currentPart.trim()) {
            parts.push(currentPart.trim());
        }
        
        return parts;
    }
}
/**
 * نظام تخزين وإدارة الرسائل
 */
class MessageStore {
    constructor() {
        this.storageKey = 'telegram_messages_advanced';
        this.quotesKey = 'customQuotes';
        this.cache = new Map();
        this.isInitialized = false;
    }

    async init() {
        await this.loadFromStorage();
        this.isInitialized = true;
        console.log('💾 تم تهيئة نظام التخزين');
    }

    // تحميل البيانات من التخزين
    async loadFromStorage() {
        try {
            const stored = localStorage.getItem(this.storageKey);
            if (stored) {
                const data = JSON.parse(stored);
                data.forEach(message => {
                    this.cache.set(message.id, message);
                });
            }
            console.log(`📥 تم تحميل ${this.cache.size} رسالة من التخزين`);
        } catch (error) {
            console.error('❌ خطأ في تحميل البيانات:', error);
        }
    }

    // حفظ البيانات في التخزين
    async saveToStorage() {
        try {
            const data = Array.from(this.cache.values());
            localStorage.setItem(this.storageKey, JSON.stringify(data));
            
            // مزامنة مع نظام الاقتباسات القديم
            await this.syncWithQuotes();
            
        } catch (error) {
            console.error('❌ خطأ في حفظ البيانات:', error);
        }
    }

    // مزامنة مع نظام الاقتباسات
    async syncWithQuotes() {
        const quotes = JSON.parse(localStorage.getItem(this.quotesKey) || '[]');
        
        // إزالة رسائل تيليجرام القديمة
        const nonTelegramQuotes = quotes.filter(q => q.source !== 'telegram');
        
        // إضافة رسائل تيليجرام الجديدة
        const telegramMessages = Array.from(this.cache.values()).map(msg => ({
            id: msg.id,
            text: msg.text,
            author: msg.author,
            date: new Date(msg.timestamp).toLocaleDateString('ar-SA'),
            time: new Date(msg.timestamp).toLocaleTimeString('ar-SA', { 
                hour: '2-digit', 
                minute: '2-digit' 
            }),
            source: 'telegram',
            telegramMessageId: msg.telegramMessageId,
            telegramUserId: msg.telegramUserId,
            edited: msg.edited || false,
            editTime: msg.editTime
        }));
        
        const allQuotes = [...nonTelegramQuotes, ...telegramMessages];
        localStorage.setItem(this.quotesKey, JSON.stringify(allQuotes));
    }

    // إضافة رسالة جديدة
    async addMessage(messageData) {
        const message = {
            id: Date.now() + Math.random(),
            text: messageData.text,
            author: messageData.author,
            telegramMessageId: messageData.telegramMessageId,
            telegramUserId: messageData.telegramUserId,
            source: 'telegram',
            timestamp: messageData.timestamp || new Date().toISOString(),
            created: new Date().toISOString(),
            edited: false
        };
        
        this.cache.set(message.id, message);
        await this.saveToStorage();
        
        return message;
    }

    // تحديث رسالة
    async updateMessage(telegramMessageId, newText) {
        const message = this.findByTelegramId(telegramMessageId);
        
        if (message && newText && newText.trim().length > 0) {
            message.text = newText.trim();
            message.edited = true;
            message.editTime = new Date().toLocaleTimeString('ar-SA', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            message.lastModified = new Date().toISOString();
            
            this.cache.set(message.id, message);
            await this.saveToStorage();
            
            return message;
        }
        
        return null;
    }

    // حذف رسالة بمعرف تيليجرام
    async deleteByTelegramId(telegramMessageId) {
        const message = this.findByTelegramId(telegramMessageId);
        
        if (message) {
            this.cache.delete(message.id);
            await this.saveToStorage();
            return true;
        }
        
        return false;
    }

    // حذف رسالة بالرقم
    async deleteByIndex(index) {
        const messages = this.getTelegramMessages();
        
        if (index > 0 && index <= messages.length) {
            const message = messages[index - 1];
            this.cache.delete(message.id);
            await this.saveToStorage();
            return message;
        }
        
        return null;
    }

    // حذف رسائل تحتوي على نص معين
    async deleteByText(searchText) {
        const messages = this.getTelegramMessages();
        const toDelete = messages.filter(msg => 
            msg.text.toLowerCase().includes(searchText.toLowerCase())
        );
        
        toDelete.forEach(msg => {
            this.cache.delete(msg.id);
        });
        
        if (toDelete.length > 0) {
            await this.saveToStorage();
        }
        
        return toDelete.length;
    }

    // حذف جميع رسائل تيليجرام
    async clearAllTelegramMessages() {
        const telegramMessages = this.getTelegramMessages();
        const count = telegramMessages.length;
        
        telegramMessages.forEach(msg => {
            this.cache.delete(msg.id);
        });
        
        if (count > 0) {
            await this.saveToStorage();
        }
        
        return count;
    }

    // البحث عن رسالة بمعرف تيليجرام
    findByTelegramId(telegramMessageId) {
        return Array.from(this.cache.values()).find(
            msg => msg.telegramMessageId === telegramMessageId
        );
    }

    // الحصول على جميع رسائل تيليجرام
    getTelegramMessages() {
        return Array.from(this.cache.values())
            .filter(msg => msg.source === 'telegram')
            .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    }

    // الحصول على عدد رسائل تيليجرام
    getTelegramMessagesCount() {
        return this.getTelegramMessages().length;
    }

    // الحصول على آخر رسالة
    getLatestMessage() {
        const messages = this.getTelegramMessages();
        return messages.length > 0 ? messages[messages.length - 1] : null;
    }

    // البحث في الرسائل
    search(query) {
        const messages = this.getTelegramMessages();
        return messages.filter(msg => 
            msg.text.toLowerCase().includes(query.toLowerCase()) ||
            msg.author.toLowerCase().includes(query.toLowerCase())
        );
    }

    // الحصول على إحصائيات
    getStats() {
        const messages = this.getTelegramMessages();
        const now = new Date();
        const today = now.toLocaleDateString('ar-SA');
        
        return {
            total: messages.length,
            today: messages.filter(msg => 
                new Date(msg.timestamp).toLocaleDateString('ar-SA') === today
            ).length,
            edited: messages.filter(msg => msg.edited).length,
            totalCharacters: messages.reduce((sum, msg) => sum + msg.text.length, 0),
            averageLength: messages.length > 0 ? 
                Math.round(messages.reduce((sum, msg) => sum + msg.text.length, 0) / messages.length) : 0
        };
    }
}
/**
 * نظام إدارة الرسائل المتقدم - للخبراء فقط
 * Advanced Message Management System - Expert Level
 */
class TelegramMessageSystem {
    constructor() {
        this.config = {
            botToken: TELEGRAM_CONFIG.BOT_TOKEN,
            chatId: TELEGRAM_CONFIG.CHAT_ID,
            syncInterval: 8000, // 8 ثوان
            maxRetries: 3,
            timeout: 10000,
            batchSize: 50
        };
        
        this.state = {
            isInitialized: false,
            isProcessing: false,
            lastUpdateId: this.getStoredUpdateId(),
            messageQueue: new Map(),
            syncTimer: null,
            retryCount: 0,
            connectionStatus: 'disconnected'
        };
        
        this.events = new EventTarget();
        this.messageStore = new MessageStore();
        this.commandProcessor = new CommandProcessor(this);
        this.uiManager = new UIManager(this);
        
        this.init();
    }

    // تهيئة النظام
    async init() {
        try {
            console.log('🚀 تهيئة نظام إدارة الرسائل المتقدم...');
            
            await this.validateConfig();
            await this.initializeComponents();
            await this.startSyncEngine();
            
            this.state.isInitialized = true;
            this.state.connectionStatus = 'connected';
            
            this.emit('system:initialized');
            console.log('✅ تم تهيئة النظام بنجاح');
            
        } catch (error) {
            console.error('❌ فشل في تهيئة النظام:', error);
            this.handleInitError(error);
        }
    }

    // التحقق من صحة الإعدادات
    async validateConfig() {
        if (!this.config.botToken || !this.config.chatId) {
            throw new Error('إعدادات تيليجرام غير مكتملة');
        }
        
        // اختبار الاتصال
        const testResponse = await this.makeRequest('getMe');
        if (!testResponse.ok) {
            throw new Error('فشل في الاتصال بتيليجرام');
        }
        
        console.log('✅ تم التحقق من الإعدادات');
    }

    // تهيئة المكونات
    async initializeComponents() {
        await this.messageStore.init();
        await this.commandProcessor.init();
        await this.uiManager.init();
        
        this.setupEventListeners();
        console.log('✅ تم تهيئة المكونات');
    }

    // بدء محرك المزامنة
    async startSyncEngine() {
        // مزامنة فورية
        await this.syncMessages();
        
        // مزامنة دورية
        this.state.syncTimer = setInterval(() => {
            this.syncMessages();
        }, this.config.syncInterval);
        
        console.log(`🔄 بدء المزامنة كل ${this.config.syncInterval/1000} ثانية`);
    }

    // مزامنة الرسائل
    async syncMessages() {
        if (this.state.isProcessing) return;
        
        try {
            this.state.isProcessing = true;
            this.emit('sync:started');
            
            const updates = await this.fetchUpdates();
            
            if (updates.length > 0) {
                console.log(`📨 معالجة ${updates.length} تحديث جديد`);
                
                for (const update of updates) {
                    await this.processUpdate(update);
                }
                
                this.updateLastUpdateId(updates);
                this.emit('sync:completed', { count: updates.length });
            }
            
            this.state.retryCount = 0;
            this.state.connectionStatus = 'connected';
            
        } catch (error) {
            console.error('❌ خطأ في المزامنة:', error);
            this.handleSyncError(error);
        } finally {
            this.state.isProcessing = false;
        }
    }

    // جلب التحديثات من تيليجرام
    async fetchUpdates() {
        const params = {
            offset: this.state.lastUpdateId + 1,
            limit: this.config.batchSize,
            timeout: 30
        };
        
        const response = await this.makeRequest('getUpdates', params);
        
        if (!response.ok) {
            throw new Error(`فشل في جلب التحديثات: ${response.description}`);
        }
        
        return response.result || [];
    }

    // معالجة التحديث الواحد
    async processUpdate(update) {
        try {
            // تحديث معرف آخر تحديث
            this.state.lastUpdateId = Math.max(this.state.lastUpdateId, update.update_id);
            
            // معالجة أنواع التحديثات المختلفة
            if (update.message) {
                await this.handleMessage(update.message);
            } else if (update.edited_message) {
                await this.handleEditedMessage(update.edited_message);
            } else if (update.callback_query) {
                await this.handleCallbackQuery(update.callback_query);
            }
            
        } catch (error) {
            console.error('❌ خطأ في معالجة التحديث:', error);
        }
    }

    // معالجة الرسائل
    async handleMessage(message) {
        const messageData = {
            id: message.message_id,
            text: message.text,
            from: message.from,
            date: message.date,
            chat: message.chat
        };
        
        // معالجة الأوامر
        if (messageData.text && messageData.text.startsWith('/')) {
            await this.commandProcessor.process(messageData);
            return;
        }
        
        // معالجة الرسائل العادية
        if (messageData.text && messageData.text.trim().length > 0) {
            await this.handleRegularMessage(messageData);
        }
    }

    // معالجة الرسائل العادية
    async handleRegularMessage(messageData) {
        const quote = await this.messageStore.addMessage({
            text: messageData.text.trim(),
            author: messageData.from.first_name || 'حبيبي',
            telegramMessageId: messageData.id,
            telegramUserId: messageData.from.id,
            source: 'telegram',
            timestamp: new Date(messageData.date * 1000).toISOString()
        });
        
        // إرسال تأكيد
        await this.sendConfirmation(messageData.id, quote);
        
        // تحديث الواجهة
        this.emit('message:added', quote);
        
        console.log('✅ تم إضافة رسالة جديدة:', messageData.text.substring(0, 50));
    }

    // معالجة الرسائل المحررة
    async handleEditedMessage(editedMessage) {
        const updated = await this.messageStore.updateMessage(
            editedMessage.message_id,
            editedMessage.text
        );
        
        if (updated) {
            this.emit('message:updated', updated);
            console.log('✏️ تم تحديث رسالة');
        }
    }

    // إرسال تأكيد للمستخدم
    async sendConfirmation(replyToId, quote) {
        const totalMessages = await this.messageStore.getTelegramMessagesCount();
        
        const confirmationText = `
✅ تم إضافة رسالتك للموقع!

📊 إحصائيات:
• رقم الرسالة: #${totalMessages}
• الوقت: ${new Date().toLocaleTimeString('ar-SA')}

🎯 أوامر مفيدة:
• /list - عرض جميع رسائلك
• /delete ${totalMessages} - حذف هذه الرسالة
• /help - المساعدة

💕 رسالتك الآن تزين الموقع!
        `.trim();
        
        await this.sendMessage(confirmationText, replyToId);
    }

    // إرسال رسالة
    async sendMessage(text, replyToId = null) {
        const params = {
            chat_id: this.config.chatId,
            text: text,
            parse_mode: 'HTML',
            disable_web_page_preview: true
        };
        
        if (replyToId) {
            params.reply_to_message_id = replyToId;
        }
        
        return await this.makeRequest('sendMessage', params);
    }

    // طلب HTTP عام
    async makeRequest(method, params = {}) {
        const url = `https://api.telegram.org/bot${this.config.botToken}/${method}`;
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.config.timeout);
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            return await response.json();
            
        } catch (error) {
            clearTimeout(timeoutId);
            throw error;
        }
    }

    // إعداد مستمعي الأحداث
    setupEventListeners() {
        // مراقبة تغيير حالة الصفحة
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && this.state.connectionStatus === 'disconnected') {
                this.reconnect();
            }
        });
        
        // مراقبة إغلاق الصفحة
        window.addEventListener('beforeunload', () => {
            this.cleanup();
        });
    }

    // إعادة الاتصال
    async reconnect() {
        console.log('🔄 إعادة الاتصال...');
        this.state.retryCount = 0;
        await this.syncMessages();
    }

    // تنظيف الموارد
    cleanup() {
        if (this.state.syncTimer) {
            clearInterval(this.state.syncTimer);
            this.state.syncTimer = null;
        }
        console.log('🧹 تم تنظيف الموارد');
    }

    // معالجة أخطاء التهيئة
    handleInitError(error) {
        this.state.connectionStatus = 'error';
        this.emit('system:error', error);
        
        // إعادة المحاولة بعد 10 ثوان
        setTimeout(() => {
            if (this.state.retryCount < this.config.maxRetries) {
                this.state.retryCount++;
                console.log(`🔄 إعادة المحاولة ${this.state.retryCount}/${this.config.maxRetries}`);
                this.init();
            }
        }, 10000);
    }

    // معالجة أخطاء المزامنة
    handleSyncError(error) {
        this.state.connectionStatus = 'error';
        this.state.retryCount++;
        
        if (this.state.retryCount >= this.config.maxRetries) {
            console.error('❌ تم الوصول للحد الأقصى من المحاولات');
            this.state.connectionStatus = 'disconnected';
        }
        
        this.emit('sync:error', error);
    }

    // إطلاق حدث
    emit(eventName, data = null) {
        this.events.dispatchEvent(new CustomEvent(eventName, { detail: data }));
    }

    // الاستماع لحدث
    on(eventName, callback) {
        this.events.addEventListener(eventName, callback);
    }

    // الحصول على معرف آخر تحديث محفوظ
    getStoredUpdateId() {
        return parseInt(localStorage.getItem('telegram_last_update_id') || '0');
    }

    // تحديث معرف آخر تحديث
    updateLastUpdateId(updates) {
        if (updates.length > 0) {
            const maxId = Math.max(...updates.map(u => u.update_id));
            this.state.lastUpdateId = maxId;
            localStorage.setItem('telegram_last_update_id', maxId.toString());
        }
    }

    // الحصول على حالة النظام
    getStatus() {
        return {
            isInitialized: this.state.isInitialized,
            connectionStatus: this.state.connectionStatus,
            isProcessing: this.state.isProcessing,
            lastUpdateId: this.state.lastUpdateId,
            retryCount: this.state.retryCount
        };
    }
}

    </script>
</body>
</html>
