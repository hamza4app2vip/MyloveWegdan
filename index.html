<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💕 لحبيبتي وجدان الغالية 💕</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* تصميم النظام المتقدم */
.advanced-telegram-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 25px;
    margin: 20px 0;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
    position: relative;
}

.advanced-telegram-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #4caf50, #2196f3, #ff9800, #e91e63);
    animation: connectionPulse 3s ease-in-out infinite;
}

/* الرأس المتقدم */
.advanced-header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    padding: 25px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.title-section {
    flex: 1;
}

.main-title {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
}

.pulse-icon {
    font-size: 2.5rem;
    color: #00d4aa;
    animation: pulse 2s infinite;
}

.main-title h2 {
    color: white;
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.15);
    padding: 8px 15px;
    border-radius: 25px;
    font-size: 0.9rem;
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    animation: statusPulse 2s infinite;
}

.status-indicator.excellent { background: #4caf50; }
.status-indicator.good { background: #8bc34a; }
.status-indicator.fair { background: #ff9800; }
.status-indicator.poor { background: #f44336; }
.status-indicator.error { background: #e91e63; }

.subtitle p {
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    font-size: 1.1rem;
}

/* لوحة الإحصائيات */
.stats-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-card:hover {
    transform: translateY(-5px);
    background: rgba(255, 255, 255, 0.2);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}

.stat-number {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: #00d4aa;
    margin-bottom: 5px;
}

.stat-label {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
}

/* لوحة التحكم */
.control-panel {
    display: flex;
    gap: 10px;
}

.control-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.control-btn.primary { background: linear-gradient(135deg, #4caf50, #45a049); }
.control-btn.secondary { background: linear-gradient(135deg, #2196f3, #1976d2); }
.control-btn.info { background: linear-gradient(135deg, #ff9800, #f57c00); }

/* قسم الرسائل */
.messages-section {
    background: white;
    min-height: 400px;
}

.section-tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.tab-btn {
    background: none;
    border: none;
    padding: 15px 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    color: #6c757d;
    position: relative;
}

.tab-btn:hover {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.tab-btn.active {
    background: white;
    color: #667eea;
    border-bottom: 3px solid #667eea;
}

.badge {
    background: #dc3545;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: bold;
    margin-left: 5px;
}

/* حاوية الرسائل */
.messages-container {
    max-height: 600px;
    overflow-y: auto;
}

.messages-display {
    padding: 20px;
}

/* عنصر الرسالة المتقدم */
.message-item.advanced {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 5px solid #667eea;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(20px);
    position: relative;
    overflow: hidden;
}

.message-item.advanced.message-appear {
    opacity: 1;
    transform: translateY(0);
}

.message-item.advanced:hover {
    transform: translateX(10px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.message-item.advanced.message-viewed {
    border-left-color: #4caf50;
    background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
}

.message-item.advanced::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, transparent, #667eea, transparent);
    animation: messageShimmer 2s ease-in-out infinite;
}

/* رأس الرسالة المتقدم */
.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.author-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.author-name {
    font-weight: 700;
    color: #2c3e50;
    font-size: 1.1rem;
}

.message-time {
    color: #7f8c8d;
    font-size: 0.9rem;
    background: rgba(127, 140, 141, 0.1);
    padding: 4px 10px;
    border-radius: 15px;
}

.new-badge {
    background: linear-gradient(135deg, #4caf50, #45a049);
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    animation: newBadgePulse 2s infinite;
}

.view-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
    color: #6c757d;
}

.view-status .text-success {
    color: #4caf50 !important;
}

/* محتوى الرسالة */
.message-content {
    margin: 15px 0;
}

.message-text {
    font-size: 1.1rem;
    line-height: 1.7;
    color: #2c3e50;
    margin: 0;
}

/* تذييل الرسالة المتقدم */
.message-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.message-actions {
    display: flex;
    gap: 10px;
}

.action-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    font-weight: 500;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.action-btn.secondary {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
}

/* متتبع المشاهدة */
.view-tracker {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: #6c757d;
    opacity: 0.7;
}

.tracker-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #6c757d;
}

.view-tracker.tracking-active .tracker-dot {
    background: #4caf50;
    animation: trackingPulse 1.5s infinite;
}

.view-tracker.tracking-active .tracker-text {
    color: #4caf50;
}

/* مؤشر المشاهدة */
.view-indicator-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(76, 175, 80, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
    animation: viewOverlayAppear 0.5s ease;
}

.view-animation {
    text-align: center;
    color: white;
    font-size: 1.2rem;
    font-weight: bold;
}

.view-animation i {
    font-size: 2rem;
    margin-bottom: 10px;
    display: block;
    animation: viewIconBounce 0.6s ease;
}

/* الحالة الفارغة المتقدمة */
.empty-state.advanced {
    text-align: center;
    padding: 80px 20px;
    color: #6c757d;
}

.empty-animation {
    position: relative;
    display: inline-block;
    margin-bottom: 30px;
}

.empty-animation i {
    font-size: 5rem;
    color: #dee2e6;
    animation: emptyFloat 3s ease-in-out infinite;
}

.pulse-ring {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    border: 2px solid #667eea;
    border-radius: 50%;
    opacity: 0;
    animation: pulseRing 2s ease-out infinite;
}

.empty-features {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 30px;
}

.feature-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    color: #667eea;
}

.feature-item i {
    font-size: 2rem;
}

/* حالة التحميل */
.loading-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.loading-animation {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}

.pulse-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #667eea;
    animation: pulseDot 1.4s ease-in-out infinite both;
}

.pulse-dot:nth-child(1) { animation-delay: -0.32s; }
.pulse-dot:nth-child(2) { animation-delay: -0.16s; }

/* التذييل */
.footer-section {
    background: #f8f9fa;
    padding: 25px;
    border-top: 1px solid #dee2e6;
}

.quick-info {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 20px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #667eea;
    font-weight: 500;
}

.send-instructions {
    text-align: center;
    color: #6c757d;
}

.send-instructions h4 {
    color: #495057;
    margin-bottom: 10px;
}

/* النوافذ المنبثقة المتقدمة */
.advanced-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: modalFadeIn 0.3s ease;
}

.modal-content {
    background: white;
    border-radius: 20px;
    max-width: 90%;
    max-height: 90%;
    overflow: hidden;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
    animation: modalSlideUp 0.3s ease;
}

.modal-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 30px;
    max-height: 70vh;
    overflow-y: auto;
}

/* شبكة الإحصائيات */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card-modal {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    border-left: 4px solid #667eea;
}

.stat-value-large {
    font-size: 3rem;
    font-weight: bold;
    color: #667eea;
    margin: 10px 0;
}

/* شريط التقدم */
.progress-section {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 25px;
}

.progress-bar {
    background: #e9ecef;
    border-radius: 25px;
    height: 20px;
    overflow: hidden;
    margin: 15px 0;
}

.progress-fill {
    background: linear-gradient(135deg, #4caf50, #45a049);
    height: 100%;
    border-radius: 25px;
    transition: width 1s ease;
    position: relative;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: progressShimmer 2s infinite;
}

/* الإشعارات الفورية */
.instant-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #4caf50, #45a049);
    color: white;
    padding: 15px 25px;
    border-radius: 25px;
    box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
    z-index: 10001;
    transform: translateX(400px);
    transition: all 0.3s ease;
}

.instant-notification.show {
    transform: translateX(0);
}

.instant-notification.info {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    box-shadow: 0 10px 30px rgba(33, 150, 243, 0.3);
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
}

/* الحركات والتأثيرات */
@keyframes connectionPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes statusPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
}

@keyframes newBadgePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

@keyframes trackingPulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}

@keyframes messageShimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

@keyframes viewOverlayAppear {
    0% { opacity: 0; transform: scale(0.8); }
    100% { opacity: 1; transform: scale(1); }
}

@keyframes viewIconBounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

@keyframes emptyFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes pulseRing {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
}

@keyframes pulseDot {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

@keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes modalSlideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes progressShimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* التصميم المتجاوب */
@media (max-width: 768px) {
    .advanced-header {
        padding: 20px;
    }
    
    .header-content {
        flex-direction: column;
        gap: 20px;
    }
    
    .stats-dashboard {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .control-panel {
        flex-direction: column;
        width: 100%;
    }
    
    .section-tabs {
        flex-direction: column;
    }
    
    .quick-info {
        flex-direction: column;
        gap: 15px;
    }
    
    .empty-features {
        flex-direction: column;
        gap: 20px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .instant-notification {
        right: 10px;
        left: 10px;
        transform: translateY(-100px);
    }
    
    .instant-notification.show {
        transform: translateY(0);
    }
}

        /* تحسين أزرار المزاج */
.mood-btn {
    transition: all 0.3s ease;
    transform: scale(1);
    position: relative;
    overflow: hidden;
}

.mood-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
}

.mood-btn.selected {
    background: linear-gradient(135deg, #ff6b9d, #c44569) !important;
    color: white !important;
    transform: scale(1.1);
    box-shadow: 0 10px 30px rgba(255, 107, 157, 0.5);
    animation: selectedPulse 2s ease-in-out infinite;
}

.mood-btn.selected::after {
    content: '✓';
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 255, 255, 0.9);
    color: #ff6b9d;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}

@keyframes selectedPulse {
    0%, 100% { box-shadow: 0 10px 30px rgba(255, 107, 157, 0.5); }
    50% { box-shadow: 0 15px 40px rgba(255, 107, 157, 0.7); }
}

/* تحسين عرض تاريخ المزاج */
.mood-history-item {
    transition: all 0.3s ease;
}

.mood-history-item:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    transform: translateX(5px);
}

/* تحسين رسالة المزاج */
.mood-message {
    background: linear-gradient(135deg, rgba(255, 107, 157, 0.1), rgba(255, 192, 203, 0.1));
    border: 2px solid rgba(255, 107, 157, 0.2);
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-pink: #ff6b9d;
            --light-pink: #ffc0cb;
            --soft-pink: #ffb3d1;
            --rose-gold: #f7cac9;
            --blush: #ffeef0;
            --white: #ffffff;
            --dark-pink: #e91e63;
            --gradient-1: linear-gradient(135deg, #ff6b9d, #ffc0cb);
            --gradient-2: linear-gradient(45deg, #ff9a9e, #fecfef);
            --gradient-3: linear-gradient(135deg, #f093fb, #f5576c);
            --shadow: 0 10px 30px rgba(255, 107, 157, 0.3);
            --text-dark: #2c2c2c;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #ffeef0 0%, #fff0f5 50%, #ffe4e6 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="hearts" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><text x="10" y="15" text-anchor="middle" fill="%23ff6b9d" opacity="0.1" font-size="12">💕</text></pattern></defs><rect width="100" height="100" fill="url(%23hearts)"/></svg>');
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            box-shadow: 0 0 50px rgba(255, 107, 157, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .header {
            background: var(--gradient-1);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.1) 10px,
                rgba(255, 255, 255, 0.1) 20px
            );
            animation: slide 15s linear infinite;
        }

        @keyframes slide {
            0% { transform: translateX(-50px); }
            100% { transform: translateX(50px); }
        }

        .header h1 {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            position: relative;
            z-index: 2;
        }

        .floating-hearts {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .heart {
            position: absolute;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.5rem;
            animation: floatUp 6s ease-in-out infinite;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .nav-tabs {
            display: flex;
            background: white;
            box-shadow: 0 2px 10px rgba(255, 107, 157, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            color: var(--primary-pink);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 0.9rem;
        }

        .nav-tab.active {
            background: var(--gradient-1);
            color: white;
        }

        .nav-tab:hover {
            background: var(--blush);
        }

        .nav-tab.active:hover {
            background: var(--gradient-1);
        }

        .content {
            padding: 20px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 192, 203, 0.3);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 107, 157, 0.4);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark-pink);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .counter-display {
            text-align: center;
            padding: 30px;
            background: var(--gradient-2);
            border-radius: 20px;
            color: white;
            margin-bottom: 20px;
        }

        .counter-number {
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .counter-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .love-meter {
            background: var(--gradient-2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .meter-container {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b9d, #ffffff);
            border-radius: 25px;
            width: 0%;
            transition: width 2s ease-in-out;
            position: relative;
        }

        .meter-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .weather-widget {
            background: var(--gradient-3);
            border-radius: 20px;
            padding: 25px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .weather-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .mood-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .mood-btn {
            background: white;
            border: 2px solid var(--light-pink);
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        .mood-btn:hover, .mood-btn.selected {
            background: var(--gradient-1);
            color: white;
            transform: scale(1.1);
        }

        .quote-container {
            background: var(--blush);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid var(--primary-pink);
            position: relative;
        }

        .quote-text {
            font-style: italic;
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--text-dark);
        }

        .quote-author {
            text-align: left;
            margin-top: 10px;
            color: var(--dark-pink);
            font-weight: 600;
        }

        .memory-timeline {
            position: relative;
            padding-right: 30px;
        }

        .memory-timeline::before {
            content: '';
            position: absolute;
            right: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gradient-1);
        }

        .memory-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.2);
        }

        .memory-item::after {
            content: '';
            position: absolute;
            right: -25px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: var(--primary-pink);
            border-radius: 50%;
            border: 3px solid white;
        }

        .memory-date {
            color: var(--dark-pink);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .memory-text {
            line-height: 1.6;
        }

        .interactive-game {
            background: var(--gradient-2);
            border-radius: 20px;
            padding: 25px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .game-cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .game-cell:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .music-player {
            background: var(--gradient-1);
            border-radius: 20px;
            padding: 25px;
            color: white;
            margin-bottom: 20px;
        }

        .music-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .music-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .music-btn.play {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            width: 0%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .calendar-widget {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: var(--primary-pink);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-nav:hover {
            background: var(--dark-pink);
            transform: scale(1.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .calendar-day:hover {
            background: var(--blush);
        }

        .calendar-day.today {
            background: var(--primary-pink);
            color: white;
        }

        .calendar-day.special {
            background: var(--gradient-1);
            color: white;
            position: relative;
        }

        .calendar-day.special::after {
            content: '💕';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
        }

        .notification-center {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .notification {
            background: var(--blush);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid var(--primary-pink);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--dark-pink);
            margin-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--gradient-2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: white;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .voice-message {
            background: var(--gradient-1);
            border-radius: 20px;
            padding: 25px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .voice-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            margin: 15px;
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .voice-btn.recording {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .surprise-box {
            background: var(--gradient-3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .surprise-box:hover {
            transform: scale(1.05);
        }

        .surprise-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .footer {
            background: var(--gradient-1);
            padding: 30px 20px;
            text-align: center;
            color: white;
            margin-top: 40px;
        }

        .footer-heart {
            font-size: 2rem;
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.3); }
            70% { transform: scale(1); }
        }

        .btn {
            background: var(--gradient-1);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-pink);
            border: 2px solid var(--primary-pink);
        }

        .btn-secondary:hover {
            background: var(--primary-pink);
            color: white;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-pink);
            font-weight: 600;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--light-pink);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--primary-pink);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--gradient-1);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .content {
                padding: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .counter-number {
                font-size: 2.5rem;
            }
            
            .nav-tab {
                padding: 12px 8px;
                font-size: 0.8rem;
            }
        }

        .sparkle {
            position: absolute;
            color: var(--primary-pink);
            font-size: 1rem;
            animation: sparkle 2s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        .typing-indicator {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="floating-hearts" id="floatingHearts"></div>
            <h1>💕 لحبيبتي الغالية 💕</h1>
            <p class="subtitle">أجمل ما في الحياة هو وجودك معي</p>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('home')">
                <i class="fas fa-home"></i><br>الرئيسية
            </button>
            <button class="nav-tab" onclick="showTab('memories')">
                <i class="fas fa-heart"></i><br>ذكرياتنا
            </button>
            <button class="nav-tab" onclick="showTab('games')">
                <i class="fas fa-gamepad"></i><br>ألعاب
            </button>
            <button class="nav-tab" onclick="showTab('tools')">
                <i class="fas fa-magic"></i><br>أدوات
            </button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Home Tab -->
            <div id="home" class="tab-content active">
                <!-- Love Counter -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-calendar-heart"></i>
                        عداد أيام حبنا
                    </h3>
                    <div class="counter-display">
                        <div class="counter-number" id="daysCounter">0</div>
                        <div class="counter-label">يوم من الحب والسعادة</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="hoursCounter">0</div>
                            <div class="stat-label">ساعة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="minutesCounter">0</div>
                            <div class="stat-label">دقيقة</div>
                        </div>
                    </div>
                </div>

                <!-- Love Meter -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-heart-pulse"></i>
                        مقياس الحب
                    </h3>
                    <div class="love-meter">
                        <h4>مستوى حبي لك اليوم</h4>
                        <div class="meter-container">
                            <div class="meter-fill" id="loveMeter"></div>
                        </div>
                        <p id="lovePercentage">100%</p>
                    </div>
                </div>

                <!-- Weather of Love -->
                <div class="weather-widget">
                    <h3><i class="fas fa-cloud-sun"></i> طقس الحب اليوم</h3>
                    <div class="weather-icon" id="weatherIcon">☀️</div>
                    <h4 id="weatherStatus">مشمس مع نسمات من الحب</h4>
                    <p id="weatherDesc">درجة الحرارة: ♾️ درجة حب</p>
                </div>

                <!-- Daily Quote -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-quote-right"></i>
                        اقتباس اليوم
                    </h3>
                    <div class="quote-container">
                        <p class="quote-text" id="dailyQuote">
                            "الحب ليس مجرد شعور، بل هو قرار نتخذه كل يوم لنكون مع الشخص الذي نحبه"
                        </p>
                        <p class="quote-author">- حمزة حبيبك</p>
                    </div>
                    <button class="btn" onclick="getNewQuote()">اقتباس جديد</button>
                </div>

                <!-- Mood Tracker -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-smile"></i>
                        كيف مزاجك اليوم؟
                    </h3>
                    <div class="mood-selector">
                        <div class="mood-btn" onclick="selectMood('happy', '😊')">😊</div>
                        <div class="mood-btn" onclick="selectMood('love', '😍')">😍</div>
                        <div class="mood-btn" onclick="selectMood('excited', '🤩')">🤩</div>
                        <div class="mood-btn" onclick="selectMood('calm', '😌')">😌</div>
                        <div class="mood-btn" onclick="selectMood('romantic', '🥰')">🥰</div>
                        <div class="mood-btn" onclick="selectMood('dreamy', '😴')">😴</div>
                        <div class="mood-btn" onclick="selectMood('playful', '😜')">😜</div>
                        <div class="mood-btn" onclick="selectMood('grateful', '😔')">😔</div>
                    </div>
                    <p id="moodMessage">اختاري مزاجك لأرسل لك رسالة مناسبة 💕</p>
                </div>
            </div>

            <!-- Memories Tab -->
            <div id="memories" class="tab-content">
                <!-- Memory Timeline -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-timeline"></i>
                        خط زمني لذكرياتنا
                    </h3>
                    <div class="memory-timeline" id="memoryTimeline">
                        <!-- Memories will be loaded here -->
                    </div>
                    <button class="btn" onclick="addMemory()">إضافة ذكرى جديدة</button>
                </div>

                <!-- Special Dates Calendar -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-calendar-check"></i>
                        تقويم المناسبات الخاصة
                    </h3>
                    <div class="calendar-widget">
                        <div class="calendar-header">
                            <button class="calendar-nav" onclick="changeMonth(-1)">‹</button>
                            <h4 id="currentMonth">يناير 2024</h4>
                            <button class="calendar-nav" onclick="changeMonth(1)">›</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Love Letters -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-envelope-heart"></i>
                        رسائل الحب
                    </h3>
                    <div id="loveLetters">
                        <!-- Love letters will be displayed here -->
                    </div>
                    <button class="btn" onclick="writeLoveLetter()">كتابة رسالة حب</button>
                </div>
            </div>

            <!-- Games Tab -->
            <div id="games" class="tab-content">
                <!-- Love Quiz -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-question-circle"></i>
                        اختبار الحب
                    </h3>
                    <div id="quizContainer">
                        <p>كم تعرفين عني؟ اختبري معلوماتك!</p>
                        <button class="btn" onclick="startQuiz()">ابدأ الاختبار</button>
                    </div>
                </div>

                <!-- Memory Game -->
                <div class="interactive-game">
                    <h3><i class="fas fa-brain"></i> لعبة الذاكرة</h3>
                    <p>اعثري على القلوب المتطابقة!</p>
                    <div class="game-grid" id="memoryGame">
                        <!-- Memory game grid will be generated here -->
                    </div>
                    <button class="btn btn-secondary" onclick="startMemoryGame()">لعبة جديدة</button>
                </div>

                <!-- Love Calculator -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-calculator"></i>
                        حاسبة الحب
                    </h3>
                    <div class="input-group">
                        <label>اسمك:</label>
                        <input type="text" id="name1" placeholder="أدخلي اسمك">
                    </div>
                    <div class="input-group">
                        <label>اسمي:</label>
                        <input type="text" id="name2" placeholder="أدخلي اسمي">
                    </div>
                    <button class="btn" onclick="calculateLove()">احسبي نسبة الحب</button>
                    <div id="loveResult"></div>
                </div>

                <!-- Surprise Box -->
                <div class="surprise-box" onclick="openSurprise()">
                    <div class="surprise-icon">🎁</div>
                    <h3>صندوق المفاجآت</h3>
                    <p>اضغطي لتحصلي على مفاجأة!</p>
                </div>
            </div>

            <!-- Tools Tab -->
            <div id="tools" class="tab-content">
                <!-- Music Player -->
                <div class="music-player">
                    <h3><i class="fas fa-music"></i> مشغل الموسيقى الرومانسية</h3>
                    <div id="currentSong">أغنية الحب الأولى</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="musicProgress"></div>
                    </div>
                    <div class="music-controls">
                        <button class="music-btn" onclick="previousSong()">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="music-btn play" onclick="togglePlay()" id="playBtn">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="music-btn" onclick="nextSong()">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                </div>

                <!-- Voice Messages -->
                <div class="voice-message">
                    <h3><i class="fas fa-microphone"></i> رسائل صوتية</h3>
                    <p>سجلي رسالة صوتية لي 💕</p>
                    <button class="voice-btn" onclick="toggleRecording()" id="recordBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <div id="voiceMessages">
                        <!-- Voice messages will be displayed here -->
                    </div>
                </div>

                <!-- Notification Center -->
                <div class="notification-center">
                    <h3 class="card-title">
                        <i class="fas fa-bell"></i>
                        مركز الإشعارات
                    </h3>
                    <div id="notifications">
                        <!-- Notifications will be displayed here -->
                    </div>
                    <button class="btn" onclick="addReminder()">إضافة تذكير</button>
                </div>
<div class="card">
    <h3 class="card-title">
        <i class="fab fa-telegram"></i>
        لوحة تحكم تيليجرام
    </h3>
    <div class="telegram-setup">
        <p><strong>الجهة المرسلة اليها:</strong> خاص </p>
        <p><strong>حالة الاتصال:</strong> <span id="connectionStatus">غير محدد</span></p>
        
        <div class="button-group">
            <button class="btn" onclick="getChatId()">الحصول على Chat ID</button>
            <button class="btn" onclick="testTelegramConnection()">تحقيق اتصال ناجح</button>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <h4>إحصائيات الإرسال:</h4>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="sentCount">0</div>
                <div class="stat-label">رسالة مرسلة</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedCount">0</div>
                <div class="stat-label">رسالة فاشلة</div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="showTelegramLogs()">عرض سجل الإرسال</button>
        <button class="btn btn-secondary" onclick="clearTelegramLogs()">مسح السجل</button>
    </div>
</div>
                <!-- Love Statistics -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-heart"></i>
                        إحصائيات الحب
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="messagesCount">∞</div>
                            <div class="stat-label"> كلام حب</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="smilesCount">∞</div>
                            <div class="stat-label">ابتسامة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="hugsCount">12000</div>
                            <div class="stat-label">وسائط</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="kissesCount">290,000</div>
                            <div class="stat-label">رسالة</div>
                        </div>
                    </div>
                </div>

                <!-- Weather Forecast -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-cloud-sun"></i>
                        توقعات طقس الحب
                    </h3>
                    <div id="weatherForecast">
                        <!-- Weather forecast will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-heart">💕</div>
            <p>صُنع بكل الحب والشوق</p>
            <p>لأجمل حبيبة في العالم</p>
            <div class="typing-indicator">
                <span>.</span><span>.</span><span>.</span>
            </div>
        </div>
      </div>
    <!-- Modals -->
    <div id="memoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('memoryModal')">&times;</span>
            <h3>إضافة ذكرى جديدة</h3>
            <div class="input-group">
                <label>التاريخ:</label>
                <input type="date" id="memoryDate">
            </div>
            <div class="input-group">
                <label>الذكرى:</label>
                <textarea id="memoryText" rows="4" placeholder="اكتبي الذكرى الجميلة..."></textarea>
            </div>
            <button class="btn" onclick="saveMemory()">حفظ الذكرى</button>
        </div>
    </div>

    <div id="letterModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('letterModal')">&times;</span>
            <h3>كتابة رسالة حب</h3>
            <div class="input-group">
                <label>العنوان:</label>
                <input type="text" id="letterTitle" placeholder="عنوان الرسالة">
            </div>
            <div class="input-group">
                <label>الرسالة:</label>
                <textarea id="letterContent" rows="6" placeholder="اكتبي رسالة الحب..."></textarea>
            </div>
            <button class="btn" onclick="saveLetter()">إرسال الرسالة</button>
        </div>
    </div>

    <div id="reminderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('reminderModal')">&times;</span>
            <h3>إضافة تذكير</h3>
            <div class="input-group">
                <label>نوع التذكير:</label>
                <select id="reminderType">
                    <option value="daily">يومي</option>
                    <option value="weekly">أسبوعي</option>
                    <option value="monthly">شهري</option>
                    <option value="special">مناسبة خاصة</option>
                </select>
            </div>
            <div class="input-group">
                <label>الرسالة:</label>
                <input type="text" id="reminderText" placeholder="نص التذكير">
            </div>
            <div class="input-group">
                <label>الوقت:</label>
                <input type="time" id="reminderTime">
            </div>
            <button class="btn" onclick="saveReminder()">حفظ التذكير</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
    // دالة اختبار الاتصال المحسنة
async function testTelegramConnection() {
    const statusElement = document.getElementById('connectionStatus');
    
    if (!statusElement) {
        console.log('عنصر الحالة غير موجود');
        return;
    }
    
    statusElement.textContent = 'جاري الاختبار...';
    statusElement.style.color = 'orange';
    
    try {
        // أولاً: اختبار معلومات البوت
        const botInfoResponse = await fetch(`https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/getMe`);
        const botInfo = await botInfoResponse.json();
        
        if (!botInfo.ok) {
            throw new Error('التوكن غير صحيح');
        }
        
        console.log('معلومات البوت:', botInfo.result);
        
        // ثانياً: محاولة الحصول على Chat ID الصحيح
        await getChatId();
        
        // ثالثاً: إرسال رسالة اختبار
        const testResult = await sendToTelegram(
            'اختبار الاتصال', 
            'مرحباً! هذه رسالة اختبار للتأكد من عمل البوت بشكل صحيح! 🤖✅\n\nإذا وصلتك هذه الرسالة، فإن الإعداد تم بنجاح! 🎉', 
            'test'
        );
        
        if (testResult) {
            statusElement.textContent = 'متصل ✅';
            statusElement.style.color = 'green';
            showToast('تم الاتصال بنجاح! تحقق من تيليجرام 📱');
        } else {
            throw new Error('فشل في إرسال رسالة الاختبار');
        }
        
    } catch (error) {
        console.error('خطأ في الاختبار:', error);
        statusElement.textContent = 'غير متصل ❌';
        statusElement.style.color = 'red';
        showToast(`خطأ: ${error.message}`);
    }
    
    updateTelegramStats();
}

    // دالة للحصول على Chat ID الصحيح
async function getChatId() {
    try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/getUpdates`);
        const data = await response.json();
        
        if (data.ok && data.result.length > 0) {
            // البحث عن آخر رسالة
            const lastMessage = data.result[data.result.length - 1];
            const chatId = lastMessage.message.chat.id;
            
            console.log('Chat ID المكتشف:', chatId);
            
            // تحديث الإعدادات
            TELEGRAM_CONFIG.CHAT_ID = chatId.toString();
            
            showToast(`تم العثور على Chat ID: ${chatId}`);
            return chatId;
        } else {
            showToast('لم يتم العثور على رسائل. أرسل رسالة للبوت أولاً!');
            return null;
        }
    } catch (error) {
        console.error('خطأ في الحصول على Chat ID:', error);
        showToast('خطأ في الحصول على Chat ID');
        return null;
    }
}

    
        // إعدادات تيليجرام// إعدادات تيليجرام مع بياناتك
const TELEGRAM_CONFIG = {
    BOT_TOKEN: '7619744256:AAGlTErNoXyRAoBwNO0f8SNwDBzIA2y1Pws', // توكن البوت الخاص بك
    CHAT_ID: '7619744256',     // معرف المحادثة (نفس ID البوت مؤقتاً)
    enabled: true              // مفعل
};

// دالة إرسال الرسائل عبر تيليجرام
async function sendToTelegram(title, content, type = 'love_letter') {
    // التحقق من تفعيل الخدمة
    if (!TELEGRAM_CONFIG.enabled || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) {
        console.log('تيليجرام غير مفعل أو الإعدادات ناقصة');
        return false;
    }

    // تنسيق الرسالة حسب النوع
    let message = '';
    let emoji = '';
    
    switch(type) {
        case 'love_letter':
            emoji = '💌';
            message = `${emoji} رسالة حب جديدة ${emoji}\n\n`;
            message += `📝 العنوان: ${title}\n\n`;
            message += `💕 الرسالة:\n${content}\n\n`;
            break;
            
        case 'memory':
            emoji = '💭';
            message = `${emoji} ذكرى جديدة ${emoji}\n\n`;
            message += `📅 التاريخ: ${title}\n\n`;
            message += `💖 الذكرى:\n${content}\n\n`;
            break;
            
        case 'mood':
            emoji = '😊';
            message = `${emoji} تحديث المزاج ${emoji}\n\n`;
            message += `🎭 المزاج: ${title}\n`;
            message += `💭 الرسالة: ${content}\n\n`;
            break;
            
        case 'test':
            emoji = '🤖';
            message = `${emoji} اختبار الاتصال ${emoji}\n\n`;
            message += `${content}\n\n`;
            break;
            
        default:
            emoji = '💕';
            message = `${emoji} رسالة جديدة ${emoji}\n\n${content}\n\n`;
    }
    
    // إضافة الوقت والتاريخ
    message += `⏰ الوقت: ${new Date().toLocaleString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    })}\n\n`;
    
    message += `💖 من حبيبتك الغالية 💖`;

    // رابط API تيليجرام
    const telegramURL = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`;
    
    try {
        // عرض رسالة تحميل
        showToast('جاري إرسال الرسالة... ⏳');
        
        // إرسال الطلب
        const response = await fetch(telegramURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: TELEGRAM_CONFIG.CHAT_ID,
                text: message,
                parse_mode: 'HTML',
                disable_web_page_preview: true
            })
        });

        // التحقق من نجاح الإرسال
        if (response.ok) {
            const result = await response.json();
            if (result.ok) {
                showToast('تم إرسال الرسالة بنجاح! 📱💕');
                
                // حفظ سجل الإرسال
                saveTelegramLog(title, content, type, 'success');
                
                // إضافة تأثير بصري
                createSparkle();
                createSparkle();
                
                return true;
            } else {
                throw new Error(result.description || 'خطأ من تيليجرام');
            }
        } else {
            throw new Error(`HTTP Error: ${response.status}`);
        }
        
    } catch (error) {
        console.error('خطأ في إرسال الرسالة:', error);
        showToast('فشل في إرسال الرسالة 😔');
        
        // حفظ سجل الخطأ
        saveTelegramLog(title, content, type, 'failed', error.message);
        
        return false;
    }
}

// دالة حفظ سجل الإرسال
function saveTelegramLog(title, content, type, status, error = null) {
    const logs = JSON.parse(localStorage.getItem('telegramLogs') || '[]');
    logs.push({
        title,
        content: content.substring(0, 100) + '...', // حفظ أول 100 حرف فقط
        type,
        status,
        error,
        timestamp: new Date().toISOString(),
        id: Date.now()
    });
    
    // الاحتفاظ بآخر 50 سجل فقط
    if (logs.length > 50) {
        logs.splice(0, logs.length - 50);
    }
    
    localStorage.setItem('telegramLogs', JSON.stringify(logs));
}


        // Global Variables
        let currentTab = 'home';
        let loveStartDate = new Date('2023-06-2'); // تغيير التاريخ حسب بداية العلاقة
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let isPlaying = false;
        let isRecording = false;
        let currentSongIndex = 0;
        let memoryGameCards = [];
        let flippedCards = [];
        let gameScore = 0;

        // Love quotes array
        const loveQuotes = [
            "الحب هو الشيء الوحيد الذي يزداد عندما نقسمه",
            "أنت لست مجرد حبيبتي، بل أنت حياتي كلها",
            "في عينيك أرى مستقبلي، وفي قلبك أجد بيتي",
            "الحب الحقيقي لا يعرف المسافات ولا الزمن",
            "أنت السبب في أن كل يوم يبدو وكأنه عيد",
            "حبك يجعل العالم أجمل والحياة أحلى",
            "وجودك مهم للغاية أنتي اكسجين",
"باذن الله تكوني لي وأنا لكِ أنتي",
"من اركان حياتي الاساسية وجدان انتي حبيبتي",
            "معك تعلمت أن الحب ليس مجرد كلمة بل حياة كاملة"
        ];

        // Songs array
        const songs = [
            "أغنية الحب الأولى",
            "لحن القلوب",
            "سيمفونية العشق",
            "نغمة الشوق",
            "أنشودة الحب"
        ];

        // Weather statuses
        const weatherStatuses = [
            { icon: "☀️", status: "مشمس مع نسمات من الحب", desc: "درجة الحرارة: ♾️ درجة حب" },
            { icon: "🌙", status: "ليلة رومانسية تحت النجوم", desc: "احتمالية الرومانسية: 100%" },
            { icon: "🌈", status: "قوس قزح من المشاعر", desc: "الرطوبة: مشبعة بالحب" },
            { icon: "💫", status: "عاصفة من النجوم والأحلام", desc: "سرعة الرياح: نسيم الحنان" },
            { icon: "🌸", status: "ربيع دائم في القلب", desc: "الضغط الجوي: مرتفع بالسعادة" }
        ];

        // Mood messages
        const moodMessages = {
            happy: "سعيدة أنك سعيدة! ابتسامتك تضيء يومي 😊",
            love: "أحبك أكثر مما تتخيلين! 😍💕",
            excited: "حماسك معدي! دعينا نصنع ذكريات جميلة 🤩",
            calm: "الهدوء معك أجمل شعور في العالم 😌",
            romantic: "أنت في مزاج رومانسي؟ أنا أيضاً! 🥰",
            dreamy: "أحلام سعيدة يا حبيبتي 😴💤",
            playful: "أحب روحك المرحة! 😜🎉",
            grateful: "حبيبك معك لا  تحزني حبيبتي"
        };

        // Quiz questions
        const quizQuestions = [
            {
                question: "اكلة اشتيها من يدك",
                options: ["دجاج", "اي شي المهم منك", "خبز", "سمك"],
                correct: 1
            },
            {
                question: "ايش اكثر شي يعجبنا فيك",
                options: ["جمالي", "صوتي", "كل شي", "اناقتي"],
                correct: 2
            },
            {
                question: "شي اتمناه منك",
                options: ["قربك", "صوتك", "كلامك", "اتمنى وجدان"],
                correct: 3
            }
        ];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            startCounters();
            generateCalendar();
            loadMemories();
            loadLoveLetters();
            loadNotifications();
            createFloatingHearts();
            updateWeather();
            animateLoveMeter();
            loadWeatherForecast();
            startMemoryGame();
        });

        function initializeApp() {
            // Set initial love meter
            setTimeout(() => {
                document.getElementById('loveMeter').style.width = '100%';
            }, 1000);

            // Add sparkle effects
            setInterval(createSparkle, 2000);

            // Update statistics
            updateStatistics();
        }

        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Update nav buttons
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            event.target.closest('.nav-tab').classList.add('active');

            currentTab = tabName;
        }

        function startCounters() {
            function updateCounters() {
                const now = new Date();
                const diff = now - loveStartDate;
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                document.getElementById('daysCounter').textContent = days;
                document.getElementById('hoursCounter').textContent = hours;
                document.getElementById('minutesCounter').textContent = minutes;
            }

            updateCounters();
            setInterval(updateCounters, 60000); // Update every minute
        }

        function animateLoveMeter() {
            const meter = document.getElementById('loveMeter');
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                } else {
                    width++;
                    meter.style.width = width + '%';
                }
            }, 20);
        }

        function getNewQuote() {
            const randomQuote = loveQuotes[Math.floor(Math.random() * loveQuotes.length)];
            document.getElementById('dailyQuote').textContent = randomQuote;
            showToast('تم تحديث الاقتباس! 💕');
        }

        function selectMood(mood, emoji) {
            // Remove previous selection
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Add selection to clicked button
            event.target.classList.add('selected');

            // Update mood message
            document.getElementById('moodMessage').textContent = moodMessages[mood];
            
            showToast(`مزاجك! ${emoji}`);
        }

        function updateWeather() {
            const randomWeather = weatherStatuses[Math.floor(Math.random() * weatherStatuses.length)];
            document.getElementById('weatherIcon').textContent = randomWeather.icon;
            document.getElementById('weatherStatus').textContent = randomWeather.status;
            document.getElementById('weatherDesc').textContent = randomWeather.desc;
        }

    function generateCalendar() {
    const monthNames = [
        'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
        'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
    ];

    // المناسبات المختلفة مع 3 مناسبات فقط
    const specialEvents = {
        // ذكريات شخصية
        personal: {
            '5-5': { message: 'ميلاد حبيبك', emoji: '💕' }
        },
        // أعياد ومناسبات
        holidays: {
            '5-2': { message: 'عيد الحب', emoji: '💖' }
        },
        // أعياد ميلاد
        birthdays: {
            '2-25': { message: 'عيد ميلادك', emoji: '🎂' }
        }
    };

    document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();

    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';

    // Add day headers
    const dayHeaders = ['أح', 'إث', 'ث', 'أر', 'خ', 'ج', 'س'];
    dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.textContent = day;
        dayHeader.style.fontWeight = 'bold';
        dayHeader.style.color = 'var(--primary-pink)';
        dayHeader.style.padding = '10px 5px';
        dayHeader.style.textAlign = 'center';
        calendarGrid.appendChild(dayHeader);
    });

    // Add empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        calendarGrid.appendChild(emptyDay);
    }

    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        // التحقق من المناسبات الخاصة
        const dateKey = `${currentMonth}-${day}`;
        let isSpecial = false;
        let eventInfo = null;
        let eventType = '';

        // البحث في جميع أنواع المناسبات
        if (specialEvents.personal[dateKey]) {
            isSpecial = true;
            eventInfo = specialEvents.personal[dateKey];
            eventType = 'personal';
        } else if (specialEvents.holidays[dateKey]) {
            isSpecial = true;
            eventInfo = specialEvents.holidays[dateKey];
            eventType = 'holiday';
        } else if (specialEvents.birthdays[dateKey]) {
            isSpecial = true;
            eventInfo = specialEvents.birthdays[dateKey];
            eventType = 'birthday';
        }

        // تطبيق التنسيق للأيام المميزة
        if (isSpecial) {
            dayElement.classList.add('special', eventType);
            dayElement.title = `${eventInfo.emoji} ${eventInfo.message}`;
            dayElement.innerHTML = `
                <div style="font-weight: bold;">${day}</div>
                <div style="font-size: 0.8rem; margin-top: 2px;">${eventInfo.emoji}</div>
            `;
            
            // إضافة تأثير نبضة للأيام المميزة
            dayElement.style.animation = 'heartbeat 2s ease-in-out infinite';
            
            // إضافة حدث النقر لإظهار رسالة
            dayElement.addEventListener('click', () => {
                showToast(`${eventInfo.emoji} ${eventInfo.message}`);
                createSparkle();
            });
        } else {
            dayElement.textContent = day;
        }

        // Mark today
        if (currentYear === today.getFullYear() && 
            currentMonth === today.getMonth() && 
            day === today.getDate()) {
            dayElement.classList.add('today');
            if (!isSpecial) {
                dayElement.style.background = 'var(--primary-pink)';
                dayElement.style.color = 'white';
            }
        }

        // إضافة تأثير التمرير للأيام العادية
        if (!isSpecial) {
            dayElement.addEventListener('mouseenter', () => {
                dayElement.style.background = 'var(--blush)';
                dayElement.style.transform = 'scale(1.1)';
            });
            
            dayElement.addEventListener('mouseleave', () => {
                if (!dayElement.classList.contains('today')) {
                    dayElement.style.background = '';
                }
                dayElement.style.transform = 'scale(1)';
            });
        }

        calendarGrid.appendChild(dayElement);
    }
}


        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
        }

        function addMemory() {
            document.getElementById('memoryModal').style.display = 'block';
        }

        function saveMemory() {
            const date = document.getElementById('memoryDate').value;
            const text = document.getElementById('memoryText').value;

            if (date && text) {
                const memories = JSON.parse(localStorage.getItem('memories') || '[]');
                memories.push({ date, text, id: Date.now() });
                localStorage.setItem('memories', JSON.stringify(memories));
                
                loadMemories();
                closeModal('memoryModal');
                showToast('تم حفظ الذكرى بنجاح! 💕');
                
                // Clear form
                document.getElementById('memoryDate').value = '';
                document.getElementById('memoryText').value = '';
            }
        }

        function loadMemories() {
            const memories = JSON.parse(localStorage.getItem('memories') || '[]');
            const timeline = document.getElementById('memoryTimeline');
            
            timeline.innerHTML = '';
            
            memories.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(memory => {
                const memoryItem = document.createElement('div');
                memoryItem.className = 'memory-item';
                memoryItem.innerHTML = `
                    <div class="memory-date">${formatDate(memory.date)}</div>
                    <div class="memory-text">${memory.text}</div>
                `;
                timeline.appendChild(memoryItem);
            });

            if (memories.length === 0) {
                timeline.innerHTML = '<p style="text-align: center; color: var(--primary-pink);">لا توجد ذكريات محفوظة بعد. ابدئي بإضافة أول ذكرى! 💕</p>';
            }
        }

        function writeLoveLetter() {
            document.getElementById('letterModal').style.display = 'block';
        }

async function saveLetter() {
    const title = document.getElementById('letterTitle').value.trim();
    const content = document.getElementById('letterContent').value.trim();

    if (!title || !content) {
        showToast('يرجى ملء جميع الحقول! 📝');
        return;
    }

    // التحقق من طول الرسالة
    if (content.length > 4000) {
        showToast('الرسالة طويلة جداً! يرجى تقصيرها 📏');
        return;
    }

    try {
        // حفظ محلياً أولاً
        const letters = JSON.parse(localStorage.getItem('loveLetters') || '[]');
        const newLetter = { 
            title, 
            content, 
            date: new Date().toISOString(),
            id: Date.now(),
            sent: false // حالة الإرسال
        };
        
        letters.push(newLetter);
        localStorage.setItem('loveLetters', JSON.stringify(letters));
        
        // إرسال عبر تيليجرام
        const sent = await sendToTelegram(title, content, 'love_letter');
        
        // تحديث حالة الإرسال
        if (sent) {
            newLetter.sent = true;
            localStorage.setItem('loveLetters', JSON.stringify(letters));
        }
        
        // تحديث العرض
        loadLoveLetters();
        closeModal('letterModal');
        
        // رسالة نجاح
        if (sent) {
            showToast('تم حفظ وإرسال رسالة الحب! 💌✨');
        } else {
            showToast('تم حفظ الرسالة محلياً فقط 💾');
        }
        
        // مسح النموذج
        document.getElementById('letterTitle').value = '';
        document.getElementById('letterContent').value = '';
        
    } catch (error) {
        console.error('خطأ في حفظ الرسالة:', error);
        showToast('حدث خطأ في حفظ الرسالة 😔');
    }
}

        function loadLoveLetters() {
            const letters = JSON.parse(localStorage.getItem('loveLetters') || '[]');
            const container = document.getElementById('loveLetters');
            
            container.innerHTML = '';
            
            letters.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(letter => {
                const letterElement = document.createElement('div');
                letterElement.className = 'quote-container';
                letterElement.style.marginBottom = '15px';
                letterElement.innerHTML = `
                    <h4 style="color: var(--dark-pink); margin-bottom: 10px;">${letter.title}</h4>
                    <p class="quote-text">${letter.content}</p>
                    <p class="quote-author">- ${formatDate(letter.date)}</p>
                `;
                container.appendChild(letterElement);
            });

            if (letters.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--primary-pink);">لا توجد رسائل حب بعد. اكتبي أول رسالة! 💌</p>';
            }
        }

        function startQuiz() {
            let currentQuestion = 0;
            let score = 0;

            function showQuestion() {
                if (currentQuestion < quizQuestions.length) {
                    const question = quizQuestions[currentQuestion];
                    const container = document.getElementById('quizContainer');
                    
                    container.innerHTML = `
                        <h4>السؤال ${currentQuestion + 1} من ${quizQuestions.length}</h4>
                        <p>${question.question}</p>
                        <div style="margin: 20px 0;">
                            ${question.options.map((option, index) => 
                                `<button class="btn btn-secondary" style="display: block; width: 100%; margin: 10px 0;" onclick="answerQuestion(${index})">${option}</button>`
                            ).join('')}
                        </div>
                    `;
                } else {
                    // Show results
                    const container = document.getElementById('quizContainer');
                    const percentage = (score / quizQuestions.length) * 100;
                    let message = '';
                    
                    if (percentage >= 80) {
                        message = 'ممتاز! تعرفينني جيداً جداً! 💕';
                    } else if (percentage >= 60) {
                        message = 'جيد! لكن يمكنك معرفة المزيد عني 😊';
                    } else {
                        message = 'ركززي في الاسئلة';
                    }
                    
                    container.innerHTML = `
                        <h4>نتيجة الاختبار</h4>
                        <div class="counter-display">
                            <div class="counter-number">${percentage}%</div>
                            <div class="counter-label">${message}</div>
                        </div>
                        <button class="btn" onclick="startQuiz()">إعادة الاختبار</button>
                    `;
                }
            }

            window.answerQuestion = function(selectedIndex) {
                if (selectedIndex === quizQuestions[currentQuestion].correct) {
                    score++;
                    showToast('إجابة صحيحة! 🎉');
                } else {
                    showToast('إجابة خاطئة 😅');
                }
                currentQuestion++;
                setTimeout(showQuestion, 1000);
            };

            showQuestion();
        }

        function startMemoryGame() {
            const gameGrid = document.getElementById('memoryGame');
            const symbols = ['💕', '💖', '💗', '💘', '💝', '💞', '💟', '❤️'];
            const cards = [...symbols, ...symbols].sort(() => Math.random() - 0.5);
            
            gameGrid.innerHTML = '';
            memoryGameCards = [];
            flippedCards = [];
            gameScore = 0;

            cards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'game-cell';
                card.dataset.symbol = symbol;
                card.dataset.index = index;
                card.textContent = '💭';
                card.onclick = () => flipCard(card);
                gameGrid.appendChild(card);
                memoryGameCards.push(card);
            });
        }

        function flipCard(card) {
            if (flippedCards.length < 2 && !card.classList.contains('flipped')) {
                card.textContent = card.dataset.symbol;
                card.classList.add('flipped');
                flippedCards.push(card);

                if (flippedCards.length === 2) {
                    setTimeout(checkMatch, 1000);
                }
            }
        }

        function checkMatch() {
            const [card1, card2] = flippedCards;
            
            if (card1.dataset.symbol === card2.dataset.symbol) {
                card1.style.background = 'var(--gradient-1)';
                card2.style.background = 'var(--gradient-1)';
                gameScore++;
                showToast('تطابق رائع! 💕');
                
                if (gameScore === 8) {
                    setTimeout(() => showToast('مبروك! أكملت اللعبة! 🎉'), 500);
                }
            } else {
                card1.textContent = '💭';
                card2.textContent = '💭';
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
            }
            
            flippedCards = [];
        }

      function calculateLove() {
    const name1 = document.getElementById('name1').value.trim();
    const name2 = document.getElementById('name2').value.trim();
    
    // الأسماء المطلوبة (غير هذه الأسماء)
    const herName = "وجدان"; // اسم حبيبتك
    const myName = "حمزة";   // اسمك
    
    if (!name1 || !name2) {
        showToast('يرجى إدخال الاسمين!');
        return;
    }
    
    // التحقق من جميع الاحتمالات الصحيحة
    const isCorrectCombination = 
        (name1.toLowerCase() === herName.toLowerCase() && name2.toLowerCase() === myName.toLowerCase()) ||
        (name1.toLowerCase() === myName.toLowerCase() && name2.toLowerCase() === herName.toLowerCase());
    
    if (isCorrectCombination) {
        // الأسماء صحيحة - نسبة مثالية
        const percentage = 100;
        
        document.getElementById('loveResult').innerHTML = `
            <div class="counter-display" style="margin-top: 20px;">
                <div class="counter-number">${percentage}%</div>
                <div class="counter-label">نسبة الحب المثالية</div>
                <p style="margin-top: 15px;">💕 حب أبدي وحقيقي! 💕</p>
                <p style="color: white; opacity: 0.9;">أنتما روحان في جسدين </p>
                <div style="margin-top: 15px; font-size: 2rem;">H💍W</div>
            </div>
        `;
        
        showToast('حب مثالي 100%! 💕👑');
        
        // إضافة تأثيرات خاصة
        createSparkle();
        setTimeout(createSparkle, 500);
        setTimeout(createSparkle, 1000);
        
    } else {
        // الأسماء خاطئة
        const percentage = Math.floor(Math.random() * 40) + 20; // 20-60%
        
        document.getElementById('loveResult').innerHTML = `
            <div class="counter-display" style="margin-top: 20px;">
                <div class="counter-number">${percentage}%</div>
                <div class="counter-label">نسبة الحب</div>
                <p style="margin-top: 15px;">🤔 هناك خطأ ما!</p>
                <p style="color: white; opacity: 0.9;">
                    تأكدي من كتابة اسمك واسمي بشكل صحيح يا حبيبتي 😘
                </p>
                <p style="color: white; opacity: 0.8; font-size: 0.9rem; margin-top: 10px;">
                    تلميح: اسمك يبدأ بحرف "${herName.charAt(0)}" واسمي يبدأ بحرف "${myName.charAt(0)}" 😉
                </p>
            </div>
        `;
        
        showToast('جربي مرة أخرى! 😉💕');
    }
}


        function openSurprise() {
            const surprises = [
                "🌹 وردة حمراء لأجمل حبيبة",
                "🍫 شوكولاتة حلوة مثلك",
                "⭐ نجمة من السماء لك",
                "🦋 فراشة جميلة مثل روحك",
                "🌙 قمر ينير ليلك",
                "💎 جوهرة ثمينة مثل قلبك",
                "🌺 زهرة عطرة لحبيبتي",
                "🫀 قلبي لك أنتي وحدك "
            ];
            
            const randomSurprise = surprises[Math.floor(Math.random() * surprises.length)];
            showToast(randomSurprise);
            
            // Add sparkle effect
            createSparkle();
        }

        function togglePlay() {
            const playBtn = document.getElementById('playBtn');
            const icon = playBtn.querySelector('i');
            
            if (isPlaying) {
                icon.className = 'fas fa-play';
                isPlaying = false;
                showToast('تم إيقاف الموسيقى');
            } else {
                icon.className = 'fas fa-pause';
                isPlaying = true;
                showToast('تشغيل الموسيقى الرومانسية 🎵');
                animateProgress();
            }
        }

        function animateProgress() {
            if (isPlaying) {
                const progress = document.getElementById('musicProgress');
                let width = 0;
                const interval = setInterval(() => {
                    if (width >= 100 || !isPlaying) {
                        clearInterval(interval);
                        if (width >= 100) {
                            nextSong();
                        }
                    } else {
                        width += 0.5;
                        progress.style.width = width + '%';
                    }
                }, 100);
            }
        }

        function nextSong() {
            currentSongIndex = (currentSongIndex + 1) % songs.length;
            document.getElementById('currentSong').textContent = songs[currentSongIndex];
            document.getElementById('musicProgress').style.width = '0%';
            showToast(`الآن: ${songs[currentSongIndex]} 🎵`);
            
            if (isPlaying) {
                animateProgress();
            }
        }

        function previousSong() {
            currentSongIndex = currentSongIndex === 0 ? songs.length - 1 : currentSongIndex - 1;
            document.getElementById('currentSong').textContent = songs[currentSongIndex];
            document.getElementById('musicProgress').style.width = '0%';
            showToast(`الآن: ${songs[currentSongIndex]} 🎵`);
            
            if (isPlaying) {
                animateProgress();
            }
        }

        function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const icon = recordBtn.querySelector('i');
            
            if (isRecording) {
                icon.className = 'fas fa-microphone';
                recordBtn.classList.remove('recording');
                isRecording = false;
                showToast('تم حفظ الرسالة الصوتية! 💕');
                addVoiceMessage();
            } else {
                icon.className = 'fas fa-stop';
                recordBtn.classList.add('recording');
                isRecording = true;
                showToast('جاري التسجيل... 🎤');
            }
        }

        function addVoiceMessage() {
            const container = document.getElementById('voiceMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'notification';
            messageDiv.innerHTML = `
                <div class="notification-time">${new Date().toLocaleTimeString('ar-SA')}</div>
                <div>رسالة صوتية جديدة 🎤💕</div>
                <button class="btn btn-secondary" style="margin-top: 10px;">تشغيل</button>
            `;
            container.appendChild(messageDiv);
        }

        function addReminder() {
            document.getElementById('reminderModal').style.display = 'block';
        }

        function saveReminder() {
            const type = document.getElementById('reminderType').value;
            const text = document.getElementById('reminderText').value;
            const time = document.getElementById('reminderTime').value;

            if (text && time) {
                const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
                reminders.push({ 
                    type, 
                    text, 
                    time, 
                    date: new Date().toISOString(),
                    id: Date.now() 
                });
                localStorage.setItem('reminders', JSON.stringify(reminders));
                
                loadNotifications();
                closeModal('reminderModal');
                showToast('تم إضافة التذكير! ⏰');
                
                // Clear form
                document.getElementById('reminderText').value = '';
                document.getElementById('reminderTime').value = '';
            }
        }

        function loadNotifications() {
            const notifications = document.getElementById('notifications');
            const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
            
            // Add some default notifications
            const defaultNotifications = [
                { text: 'لا تنسي أن تبتسمي اليوم! 😊', time: new Date().toLocaleTimeString('ar-SA') },
                { text: 'أحبك أكثر من الأمس وكل يوم أكثر  💕', time: new Date().toLocaleTimeString('ar-SA') },
                { text: 'أنت أجمل ما في حياتي 🌹', time: new Date().toLocaleTimeString('ar-SA') }
            ];
            
            notifications.innerHTML = '';
            
            [...defaultNotifications, ...reminders].forEach(notification => {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification';
                notificationDiv.innerHTML = `
                    <div class="notification-time">${notification.time}</div>
                    <div>${notification.text}</div>
                `;
                notifications.appendChild(notificationDiv);
            });
        }

        function updateStatistics() {
            // Animate statistics with random increments
            const stats = ['messagesCount', 'hugsCount', 'kissesCount'];
            stats.forEach(statId => {
                const element = document.getElementById(statId);
                if (element && element.textContent !== '∞') {
                    const currentValue = parseInt(element.textContent.replace(',', ''));
                    const increment = Math.floor(Math.random() * 5) + 1;
                    element.textContent = (currentValue + increment).toLocaleString();
                }
            });
        }

        function loadWeatherForecast() {
            const forecast = document.getElementById('weatherForecast');
            const days = ['اليوم', 'غداً', 'بعد غد', 'الخميس', 'الجمعة'];
            const conditions = ['☀️ مشمس', '🌙 رومانسي', '💫 ساحر', '🌈 ملون', '🌸 جميل'];
            
            forecast.innerHTML = '';
            
            days.forEach((day, index) => {
                const dayForecast = document.createElement('div');
                dayForecast.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px;
                    margin: 5px 0;
                    background: var(--blush);
                    border-radius: 10px;
                `;
                
                dayForecast.innerHTML = `
                    <span>${day}</span>
                    <span>${conditions[index]}</span>
                    <span>♾️°</span>
                `;
                
                forecast.appendChild(dayForecast);
            });
        }

        function createFloatingHearts() {
            const container = document.getElementById('floatingHearts');
            
            setInterval(() => {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.textContent = ['💕', '💖', '💗', '💘'][Math.floor(Math.random() * 4)];
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDuration = (Math.random() * 3 + 3) + 's';
                
                container.appendChild(heart);
                
                setTimeout(() => {
                    heart.remove();
                }, 6000);
            }, 2000);
        }

        function createSparkle() {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.textContent = '✨';
            sparkle.style.left = Math.random() * window.innerWidth + 'px';
            sparkle.style.top = Math.random() * window.innerHeight + 'px';
            
            document.body.appendChild(sparkle);
            
            setTimeout(() => {
                sparkle.remove();
            }, 2000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Update statistics periodically
        setInterval(updateStatistics, 30000); // Every 30 seconds

        // Update weather periodically
        setInterval(updateWeather, 300000); // Every 5 minutes

        // Auto-save functionality
        setInterval(() => {
            const currentData = {
                lastVisit: new Date().toISOString(),
                totalVisits: (parseInt(localStorage.getItem('totalVisits')) || 0) + 1
            };
            localStorage.setItem('appData', JSON.stringify(currentData));
        }, 60000); // Every minute
        // تشغيل النظام المتكامل الجديد
let advancedTelegramSystem = null;
let advancedUI = null;

// بدء النظام عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // تأخير قصير للتأكد من تحميل كل شيء
    setTimeout(async () => {
        try {
            console.log('🚀 بدء تشغيل النظام المتقدم...');
            
            // تهيئة النظام المتقدم
            advancedTelegramSystem = new AdvancedTelegramSystem();
            
            // انتظار التهيئة
            await new Promise(resolve => {
                advancedTelegramSystem.on('system:ready', resolve);
                setTimeout(resolve, 5000); // حد أقصى 5 ثوان
            });
            
            // تهيئة واجهة المستخدم المتقدمة
            advancedUI = advancedTelegramSystem.uiManager;
            
            // إتاحة الوصول العام
            window.advancedTelegramSystem = advancedTelegramSystem;
            window.advancedUI = advancedUI;
            
            console.log('✅ النظام المتقدم جاهز للعمل!');
            
            // إشعار نجاح التشغيل
            if (advancedUI) {
                advancedUI.showInstantNotification('🚀 النظام المتقدم جاهز!', 'success');
            }
            
        } catch (error) {
            console.error('❌ فشل في تشغيل النظام المتقدم:', error);
        }
    }, 1000);
});

// تنظيف عند إغلاق الصفحة
window.addEventListener('beforeunload', function() {
    if (advancedTelegramSystem) {
        advancedTelegramSystem.cleanup();
    }
});

// إعادة الاتصال عند العودة للصفحة
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && advancedTelegramSystem) {
        advancedTelegramSystem.instantSync();
    }
});

// مراقبة حالة الشبكة
window.addEventListener('online', function() {
    if (advancedTelegramSystem) {
        advancedTelegramSystem.instantSync();
        if (advancedUI) {
            advancedUI.showInstantNotification('🌐 تم استعادة الاتصال', 'success');
        }
    }
});

window.addEventListener('offline', function() {
    if (advancedUI) {
        advancedUI.showInstantNotification('⚠️ انقطع الاتصال بالإنترنت', 'warning');
    }
});
/**
 * مدير الواجهة المتقدم مع متابعة المشاهدة
 */
class AdvancedUIManager {
    constructor(telegramSystem) {
        this.telegramSystem = telegramSystem;
        this.elements = {};
        this.isInitialized = false;
        this.animationQueue = [];
    }

    async init() {
        this.createAdvancedInterface();
        this.setupAdvancedEventListeners();
        this.startRealTimeUpdates();
        this.isInitialized = true;
        console.log('🎨 تم تهيئة الواجهة المتقدمة');
    }

    // إنشاء الواجهة المتقدمة
    createAdvancedInterface() {
        let container = document.getElementById('advancedTelegramContainer');
        
        if (!container) {
            container = document.createElement('div');
            container.id = 'advancedTelegramContainer';
            container.className = 'advanced-telegram-section';
            
            const targetElement = document.querySelector('.quotes-section') || 
                                 document.querySelector('#quotesContent') ||
                                 document.body;
            
            targetElement.insertBefore(container, targetElement.firstChild);
        }
        
        container.innerHTML = this.getAdvancedHTML();
        this.cacheElements();
        this.updateDisplay();
    }

    // HTML المتقدم
    getAdvancedHTML() {
        return `
            <div class="advanced-header">
                <div class="header-content">
                    <div class="title-section">
                        <div class="main-title">
                            <i class="fab fa-telegram pulse-icon"></i>
                            <h2>رسائل الحب المباشرة</h2>
                            <div class="connection-status" id="connectionStatus">
                                <div class="status-indicator"></div>
                                <span class="status-text">جاري الاتصال...</span>
                            </div>
                        </div>
                        <div class="subtitle">
                            <p>💕 إرسال فوري • متابعة المشاهدة • اتصال تلقائي</p>
                        </div>
                    </div>
                    
                    <div class="stats-dashboard">
                        <div class="stat-card">
                            <div class="stat-icon">📨</div>
                            <div class="stat-info">
                                <span class="stat-number" id="totalMessagesCount">0</span>
                                <span class="stat-label">إجمالي الرسائل</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">👀</div>
                            <div class="stat-info">
                                <span class="stat-number" id="viewedMessagesCount">0</span>
                                <span class="stat-label">تم مشاهدتها</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">⏱️</div>
                            <div class="stat-info">
                                <span class="stat-number" id="lastSyncTime">--:--</span>
                                <span class="stat-label">آخر تحديث</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">📊</div>
                            <div class="stat-info">
                                <span class="stat-number" id="viewRate">0%</span>
                                <span class="stat-label">معدل المشاهدة</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-panel">
                    <button class="control-btn primary" onclick="advancedUI.forceSync()" title="مزامنة فورية">
                        <i class="fas fa-sync-alt"></i>
                        <span>مزامنة</span>
                    </button>
                    <button class="control-btn secondary" onclick="advancedUI.showViewStats()" title="إحصائيات المشاهدة">
                        <i class="fas fa-chart-line"></i>
                        <span>الإحصائيات</span>
                    </button>
                    <button class="control-btn info" onclick="advancedUI.showConnectionInfo()" title="معلومات الاتصال">
                        <i class="fas fa-info-circle"></i>
                        <span>الاتصال</span>
                    </button>
                </div>
            </div>
            
            <div class="messages-section">
                <div class="section-tabs">
                    <button class="tab-btn active" onclick="advancedUI.switchTab('all')" data-tab="all">
                        <i class="fas fa-list"></i>
                        جميع الرسائل
                    </button>
                    <button class="tab-btn" onclick="advancedUI.switchTab('unviewed')" data-tab="unviewed">
                        <i class="fas fa-eye-slash"></i>
                        غير مشاهدة
                        <span class="badge" id="unviewedBadge">0</span>
                    </button>
                    <button class="tab-btn" onclick="advancedUI.switchTab('viewed')" data-tab="viewed">
                        <i class="fas fa-eye"></i>
                        تم مشاهدتها
                    </button>
                </div>
                
                <div class="messages-container">
                    <div id="messagesDisplay" class="messages-display">
                        <div class="loading-state">
                            <div class="loading-animation">
                                <div class="pulse-dot"></div>
                                <div class="pulse-dot"></div>
                                <div class="pulse-dot"></div>
                            </div>
                            <p>جاري تحميل الرسائل...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer-section">
                <div class="quick-info">
                    <div class="info-item">
                        <i class="fas fa-bolt"></i>
                        <span>مزامنة كل ثانية</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-eye"></i>
                        <span>متابعة المشاهدة التلقائية</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-heart"></i>
                        <span>إشعارات فورية</span>
                    </div>
                </div>
                
                <div class="send-instructions">
                    <h4>💌 كيفية الإرسال:</h4>
                    <p>اكتب رسالتك في تيليجرام وسترى النتيجة فوراً هنا!</p>
                    <p>👀 ستحصل على إشعار عندما تتم مشاهدة رسالتك</p>
                </div>
            </div>
        `;
    }

    // تخزين مؤقت للعناصر
    cacheElements() {
        this.elements = {
            connectionStatus: document.getElementById('connectionStatus'),
            totalMessagesCount: document.getElementById('totalMessagesCount'),
            viewedMessagesCount: document.getElementById('viewedMessagesCount'),
            lastSyncTime: document.getElementById('lastSyncTime'),
            viewRate: document.getElementById('viewRate'),
            unviewedBadge: document.getElementById('unviewedBadge'),
            messagesDisplay: document.getElementById('messagesDisplay')
        };
    }

    // إعداد مستمعي الأحداث المتقدمة
    setupAdvancedEventListeners() {
        // الاستماع لأحداث النظام
        this.telegramSystem.on('message:instant', (event) => {
            this.onInstantMessage(event.detail);
        });
        
        this.telegramSystem.on('message:viewed', (event) => {
            this.onMessageViewed(event.detail);
        });
        
        this.telegramSystem.on('connection:quality', (event) => {
            this.updateConnectionStatus(event.detail);
        });
        
        this.telegramSystem.on('sync:instant', (event) => {
            this.onInstantSync(event.detail);
        });
    }

    // بدء التحديثات الفورية
    startRealTimeUpdates() {
        // تحديث كل ثانية
        setInterval(() => {
            this.updateStats();
            this.updateLastSyncTime();
        }, 1000);
        
        // تحديث الاتصال كل 5 ثوان
        setInterval(() => {
            this.updateConnectionDisplay();
        }, 5000);
    }

    // معالج الرسالة الفورية
    onInstantMessage(message) {
        this.addMessageToDisplay(message);
        this.updateStats();
        this.showInstantNotification('💌 وصلت رسالة جديدة!');
        this.startViewTracking(message);
    }

    // معالج مشاهدة الرسالة
    onMessageViewed(data) {
        this.markMessageAsViewed(data.messageId);
        this.updateStats();
        this.showViewNotification(data.messageId);
    }

    // معالج المزامنة الفورية
    onInstantSync(data) {
        if (data.count > 0) {
            this.updateDisplay();
        }
        this.updateLastSyncTime();
    }

    // إضافة رسالة للعرض
    addMessageToDisplay(message) {
        const messageElement = this.createMessageElement(message);
        
        // إضافة في المقدمة
        const container = this.elements.messagesDisplay;
        if (container.firstChild && container.firstChild.classList?.contains('loading-state')) {
            container.innerHTML = '';
        }
        
        container.insertBefore(messageElement, container.firstChild);
        
        // تأثير الظهور
        requestAnimationFrame(() => {
            messageElement.classList.add('message-appear');
        });
        
        // بدء متابعة المشاهدة
        this.telegramSystem.viewTracker.observeElement(messageElement, message.id);
    }

    // إنشاء عنصر الرسالة
    createMessageElement(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-item advanced';
        messageDiv.dataset.messageId = message.id;
        
        const timeAgo = this.getTimeAgo(new Date(message.timestamp));
        const isRecent = Date.now() - new Date(message.timestamp).getTime() < 60000; // دقيقة واحدة
        
        messageDiv.innerHTML = `
            <div class="message-header">
                <div class="message-meta">
                    <div class="author-info">
                        <span class="author-name">${message.author}</span>
                        <span class="message-time">${timeAgo}</span>
                    </div>
                    <div class="message-status">
                        ${isRecent ? '<span class="new-badge">جديد</span>' : ''}
                        <div class="view-status" id="viewStatus_${message.id}">
                            <i class="fas fa-clock"></i>
                            <span>في انتظار المشاهدة</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="message-content">
                <p class="message-text">${this.escapeHTML(message.text)}</p>
            </div>
            
            <div class="message-footer">
                <div class="message-actions">
                    <button class="action-btn" onclick="advancedUI.displayAsQuote('${this.escapeHTML(message.text)}', '${message.author}')">
                        <i class="fas fa-quote-right"></i>
                        عرض كاقتباس
                    </button>
                    <button class="action-btn secondary" onclick="advancedUI.copyMessage('${this.escapeHTML(message.text)}')">
                        <i class="fas fa-copy"></i>
                        نسخ
                    </button>
                </div>
                
                <div class="view-tracker">
                    <div class="tracker-dot"></div>
                    <span class="tracker-text">متابعة المشاهدة نشطة</span>
                </div>
            </div>
        `;
        
        return messageDiv;
    }

    // تمييز الرسالة كمشاهدة
    markMessageAsViewed(messageId) {
        const viewStatus = document.getElementById(`viewStatus_${messageId}`);
        if (viewStatus) {
            viewStatus.innerHTML = `
                <i class="fas fa-eye text-success"></i>
                <span class="text-success">تم المشاهدة</span>
            `;
            
            // إضافة تأثير المشاهدة
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.classList.add('message-viewed');
                
                // إضافة مؤشر المشاهدة
                const viewIndicator = document.createElement('div');
                viewIndicator.className = 'view-indicator-overlay';
                viewIndicator.innerHTML = `
                    <div class="view-animation">
                        <i class="fas fa-eye"></i>
                        <span>تم المشاهدة!</span>
                    </div>
                `;
                
                messageElement.appendChild(viewIndicator);
                
                // إزالة المؤشر بعد 3 ثوان
                setTimeout(() => {
                    viewIndicator.remove();
                }, 3000);
            }
        }
    }

    // بدء متابعة المشاهدة
    startViewTracking(message) {
        // إضافة مؤشر المتابعة
        setTimeout(() => {
            const messageElement = document.querySelector(`[data-message-id="${message.id}"]`);
            if (messageElement) {
                const tracker = messageElement.querySelector('.view-tracker');
                if (tracker) {
                    tracker.classList.add('tracking-active');
                }
            }
        }, 1000);
    }

    // تحديث الإحصائيات
    updateStats() {
        const stats = this.telegramSystem.messageStore.getViewStats();
        
        if (this.elements.totalMessagesCount) {
            this.animateNumber(this.elements.totalMessagesCount, stats.total);
        }
        
        if (this.elements.viewedMessagesCount) {
            this.animateNumber(this.elements.viewedMessagesCount, stats.viewed);
        }
        
        if (this.elements.viewRate) {
            this.elements.viewRate.textContent = `${stats.viewRate}%`;
        }
        
        if (this.elements.unviewedBadge) {
            this.elements.unviewedBadge.textContent = stats.unviewed;
            this.elements.unviewedBadge.style.display = stats.unviewed > 0 ? 'inline' : 'none';
        }
    }

    // تحديث وقت آخر مزامنة
    updateLastSyncTime() {
        if (this.elements.lastSyncTime) {
            this.elements.lastSyncTime.textContent = new Date().toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
    }

    // تحديث حالة الاتصال
    updateConnectionStatus(quality) {
        if (!this.elements.connectionStatus) return;
        
        const indicator = this.elements.connectionStatus.querySelector('.status-indicator');
        const text = this.elements.connectionStatus.querySelector('.status-text');
        
        const statusConfig = {
            'excellent': { class: 'excellent', text: 'ممتاز', color: '#4caf50' },
            'good': { class: 'good', text: 'جيد', color: '#8bc34a' },
            'fair': { class: 'fair', text: 'متوسط', color: '#ff9800' },
            'poor': { class: 'poor', text: 'ضعيف', color: '#f44336' },
            'error': { class: 'error', text: 'خطأ', color: '#e91e63' }
        };
        
        const config = statusConfig[quality] || statusConfig['poor'];
        
        indicator.className = `status-indicator ${config.class}`;
        text.textContent = config.text;
        text.style.color = config.color;
    }

    // تحديث عرض الاتصال
    updateConnectionDisplay() {
        const status = this.telegramSystem.getSystemStatus();
        this.updateConnectionStatus(status.connectionQuality);
    }

    // تحديث العرض الكامل
    updateDisplay() {
        const currentTab = document.querySelector('.tab-btn.active')?.dataset.tab || 'all';
        this.switchTab(currentTab);
    }

    // تبديل التبويب
    switchTab(tabName) {
        // تحديث أزرار التبويب
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // تحديث المحتوى
        let messages = [];
        switch(tabName) {
            case 'all':
                messages = Array.from(this.telegramSystem.messageStore.cache.values());
                break;
            case 'unviewed':
                messages = this.telegramSystem.messageStore.getUnviewedMessages();
                break;
            case 'viewed':
                messages = this.telegramSystem.messageStore.getViewedMessages();
                break;
        }
        
        this.displayMessages(messages);
    }

    // عرض الرسائل
    displayMessages(messages) {
        if (!this.elements.messagesDisplay) return;
        
        if (messages.length === 0) {
            this.elements.messagesDisplay.innerHTML = this.getEmptyStateHTML();
            return;
        }
        
        // ترتيب الرسائل (الأحدث أولاً)
        messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        this.elements.messagesDisplay.innerHTML = '';
        
        messages.forEach((message, index) => {
            const messageElement = this.createMessageElement(message);
            messageElement.style.animationDelay = `${index * 0.1}s`;
            this.elements.messagesDisplay.appendChild(messageElement);
            
            // بدء متابعة المشاهدة للرسائل غير المشاهدة
            if (!message.viewed) {
                this.telegramSystem.viewTracker.observeElement(messageElement, message.id);
            }
        });
    }

    // HTML للحالة الفارغة
    getEmptyStateHTML() {
        return `
            <div class="empty-state advanced">
                <div class="empty-animation">
                    <i class="fab fa-telegram"></i>
                    <div class="pulse-ring"></div>
                </div>
                <h3>لا توجد رسائل</h3>
                <p>أرسل رسالة من تيليجرام لتظهر هنا فوراً</p>
                <div class="empty-features">
                    <div class="feature-item">
                        <i class="fas fa-bolt"></i>
                        <span>إرسال فوري</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-eye"></i>
                        <span>متابعة المشاهدة</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-bell"></i>
                        <span>إشعارات تلقائية</span>
                    </div>
                </div>
            </div>
        `;
    }

    // مزامنة فورية
    async forceSync() {
        const syncBtn = document.querySelector('.control-btn.primary i');
        if (syncBtn) {
            syncBtn.classList.add('fa-spin');
        }
        
        await this.telegramSystem.instantSync();
        this.showInstantNotification('🔄 تم التحديث بنجاح');
        
        setTimeout(() => {
            if (syncBtn) {
                syncBtn.classList.remove('fa-spin');
            }
        }, 1000);
    }

    // عرض إحصائيات المشاهدة
    showViewStats() {
        const stats = this.telegramSystem.messageStore.getViewStats();
        const viewStats = this.telegramSystem.viewTracker.getViewStats();
        
        const modal = this.createModal('📊 إحصائيات المشاهدة المتقدمة', `
            <div class="stats-grid">
                <div class="stat-card-modal">
                    <h4>📨 الرسائل</h4>
                    <div class="stat-value-large">${stats.total}</div>
                    <p>إجمالي الرسائل المرسلة</p>
                </div>
                
                <div class="stat-card-modal">
                    <h4>👀 المشاهدات</h4>
                    <div class="stat-value-large">${stats.viewed}</div>
                    <p>رسائل تم مشاهدتها</p>
                </div>
                
                <div class="stat-card-modal">
                    <h4>📊 معدل المشاهدة</h4>
                    <div class="stat-value-large">${stats.viewRate}%</div>
                    <p>نسبة الرسائل المشاهدة</p>
                </div>
                
                <div class="stat-card-modal">
                    <h4>⏱️ متوسط وقت المشاهدة</h4>
                    <div class="stat-value-large">${viewStats.averageViewTime}ث</div>
                    <p>الوقت حتى المشاهدة</p>
                </div>
            </div>
            
            <div class="progress-section">
                <h4>📈 تقدم المشاهدة</h4>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${stats.viewRate}%"></div>
                </div>
                <p>${stats.viewed} من ${stats.total} رسالة تم مشاهدتها</p>
            </div>
        `);
        
        document.body.appendChild(modal);
    }

    // عرض معلومات الاتصال
    showConnectionInfo() {
        const status = this.telegramSystem.getSystemStatus();
        
        const modal = this.createModal('🔗 معلومات الاتصال', `
            <div class="connection-info">
                <div class="info-section">
                    <h4>🌐 حالة الاتصال</h4>
                    <div class="status-display ${status.connectionQuality}">
                        <div class="status-dot"></div>
                        <span>${this.getQualityText(status.connectionQuality)}</span>
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>⚡ المزامنة</h4>
                    <p>كل ثانية واحدة (فوري)</p>
                    <p>آخر نبضة قلب: ${status.lastHeartbeat ? new Date(status.lastHeartbeat).toLocaleTimeString('ar-SA') : 'غير متاح'}</p>
                </div>
                
                <div class="info-section">
                    <h4>📊 الإحصائيات</h4>
                    <p>إجمالي الرسائل: ${status.totalMessages}</p>
                    <p>الرسائل المشاهدة: ${status.viewedMessages}</p>
                    <p>محاولات إعادة الاتصال: ${status.retryCount}</p>
                </div>
                
                <div class="info-section">
                    <h4>🔧 الميزات النشطة</h4>
                    <ul class="features-list">
                        <li>✅ إرسال فوري (ثانية واحدة)</li>
                        <li>✅ متابعة المشاهدة التلقائية</li>
                        <li>✅ إشعارات المشاهدة</li>
                        <li>✅ إعادة الاتصال التلقائي</li>
                        <li>✅ نبضات القلب</li>
                    </ul>
                </div>
            </div>
        `);
        
        document.body.appendChild(modal);
    }

    // عرض كاقتباس
    displayAsQuote(text, author) {
        if (typeof displayQuote === 'function') {
            displayQuote(text, `💌 ${author}`);
            this.showInstantNotification('✨ تم عرض الرسالة كاقتباس!');
        }
    }

    // نسخ الرسالة
    async copyMessage(text) {
        try {
            await navigator.clipboard.writeText(text);
            this.showInstantNotification('📋 تم نسخ الرسالة');
        } catch (err) {
            console.error('خطأ في النسخ:', err);
        }
    }

    // إنشاء نافذة منبثقة
    createModal(title, content) {
        const modal = document.createElement('div');
        modal.className = 'advanced-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>${title}</h3>
                    <button class="close-btn" onclick="this.closest('.advanced-modal').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
            </div>
        `;
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        return modal;
    }

    // عرض إشعار فوري
    showInstantNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `instant-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // تأثير الظهور
        requestAnimationFrame(() => {
            notification.classList.add('show');
        });
        
        // إزالة بعد 3 ثوان
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }

    // عرض إشعار المشاهدة
    showViewNotification(messageId) {
        const message = this.telegramSystem.messageStore.cache.get(messageId);
        if (!message) return;
        
        const shortText = message.text.length > 30 ? 
            message.text.substring(0, 30) + '...' : message.text;
        
        this.showInstantNotification(`👀 تم مشاهدة: "${shortText}"`, 'info');
    }

    // تحريك الأرقام
    animateNumber(element, targetNumber) {
        const currentNumber = parseInt(element.textContent) || 0;
        if (currentNumber === targetNumber) return;
        
        const increment = targetNumber > currentNumber ? 1 : -1;
        const duration = Math.abs(targetNumber - currentNumber) * 50;
        const steps = Math.abs(targetNumber - currentNumber);
        const stepDuration = duration / steps;
        
        let current = currentNumber;
        const timer = setInterval(() => {
            current += increment;
            element.textContent = current;
            
            if (current === targetNumber) {
                clearInterval(timer);
            }
        }, stepDuration);
    }

    // الحصول على نص الجودة
    getQualityText(quality) {
        const texts = {
            'excellent': 'ممتاز',
            'good': 'جيد',
            'fair': 'متوسط',
            'poor': 'ضعيف',
            'error': 'خطأ'
        };
        return texts[quality] || 'غير معروف';
    }

    // تنسيق الوقت المنقضي
    getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffSecs = Math.floor(diffMs / 1000);
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        
        if (diffSecs < 60) return 'الآن';
        if (diffMins < 60) return `${diffMins} د`;
        if (diffHours < 24) return `${diffHours} س`;
        
        return date.toLocaleDateString('ar-SA');
    }

    // تشفير HTML
    escapeHTML(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}
/**
 * نظام التخزين المتقدم مع متابعة المشاهدة
 */
class AdvancedMessageStore {
    constructor() {
        this.storageKey = 'telegram_messages_advanced_v2';
        this.viewsKey = 'telegram_message_views';
        this.cache = new Map();
        this.viewsCache = new Map();
        this.isInitialized = false;
    }

    async init() {
        await this.loadFromStorage();
        await this.loadViewsFromStorage();
        this.isInitialized = true;
        console.log('💾 تم تهيئة نظام التخزين المتقدم');
    }

    // تحميل البيانات من التخزين
    async loadFromStorage() {
        try {
            const stored = localStorage.getItem(this.storageKey);
            if (stored) {
                const data = JSON.parse(stored);
                data.forEach(message => {
                    this.cache.set(message.id, message);
                });
            }
            console.log(`📥 تم تحميل ${this.cache.size} رسالة`);
        } catch (error) {
            console.error('❌ خطأ في تحميل الرسائل:', error);
        }
    }

    // تحميل بيانات المشاهدة
    async loadViewsFromStorage() {
        try {
            const stored = localStorage.getItem(this.viewsKey);
            if (stored) {
                const data = JSON.parse(stored);
                data.forEach(view => {
                    this.viewsCache.set(view.messageId, view);
                });
            }
            console.log(`👀 تم تحميل ${this.viewsCache.size} مشاهدة`);
        } catch (error) {
            console.error('❌ خطأ في تحميل المشاهدات:', error);
        }
    }

    // حفظ فوري
    async saveInstant() {
        try {
            // حفظ الرسائل
            const messages = Array.from(this.cache.values());
            localStorage.setItem(this.storageKey, JSON.stringify(messages));
            
            // حفظ المشاهدات
            const views = Array.from(this.viewsCache.values());
            localStorage.setItem(this.viewsKey, JSON.stringify(views));
            
            // مزامنة مع نظام الاقتباسات
            await this.syncWithQuotesInstant();
            
        } catch (error) {
            console.error('❌ خطأ في الحفظ الفوري:', error);
        }
    }

    // مزامنة فورية مع الاقتباسات
    async syncWithQuotesInstant() {
        const quotes = JSON.parse(localStorage.getItem('customQuotes') || '[]');
        const nonTelegramQuotes = quotes.filter(q => q.source !== 'telegram');
        
        const telegramMessages = Array.from(this.cache.values()).map(msg => {
            const view = this.viewsCache.get(msg.id);
            return {
                id: msg.id,
                text: msg.text,
                author: msg.author,
                date: new Date(msg.timestamp).toLocaleDateString('ar-SA'),
                time: new Date(msg.timestamp).toLocaleTimeString('ar-SA', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }),
                source: 'telegram',
                telegramMessageId: msg.telegramMessageId,
                telegramUserId: msg.telegramUserId,
                viewed: view ? view.viewed : false,
                viewTime: view ? view.viewTime : null,
                viewDuration: view ? view.viewDuration : null
            };
        });
        
        const allQuotes = [...nonTelegramQuotes, ...telegramMessages];
        localStorage.setItem('customQuotes', JSON.stringify(allQuotes));
    }

    // إضافة رسالة فورية
    async addMessageInstant(messageData) {
        const message = {
            id: Date.now() + Math.random(),
            text: messageData.text,
            author: messageData.author,
            telegramMessageId: messageData.telegramMessageId,
            telegramUserId: messageData.telegramUserId,
            source: 'telegram',
            timestamp: messageData.timestamp || new Date().toISOString(),
            created: new Date().toISOString(),
            viewed: false
        };
        
        this.cache.set(message.id, message);
        await this.saveInstant();
        
        return message;
    }

    // تمييز كمشاهدة
    async markAsViewed(messageId, viewTime) {
        const view = {
            messageId: messageId,
            viewed: true,
            viewTime: viewTime,
            viewDuration: Date.now() - (this.cache.get(messageId)?.created ? new Date(this.cache.get(messageId).created).getTime() : Date.now())
        };
        
        this.viewsCache.set(messageId, view);
        
        // تحديث الرسالة
        const message = this.cache.get(messageId);
        if (message) {
            message.viewed = true;
            message.viewTime = viewTime;
            this.cache.set(messageId, message);
        }
        
        await this.saveInstant();
        return view;
    }

    // الحصول على رسالة
    async getMessage(messageId) {
        return this.cache.get(messageId);
    }

    // الحصول على رسائل غير مشاهدة
    getUnviewedMessages() {
        return Array.from(this.cache.values()).filter(msg => !msg.viewed);
    }

    // الحصول على رسائل مشاهدة
    getViewedMessages() {
        return Array.from(this.cache.values()).filter(msg => msg.viewed);
    }

    // إحصائيات المشاهدة
    getViewStats() {
        const total = this.cache.size;
        const viewed = this.getViewedMessages().length;
        const unviewed = this.getUnviewedMessages().length;
        
        return {
            total,
            viewed,
            unviewed,
            viewRate: total > 0 ? (viewed / total * 100).toFixed(1) : 0
        };
    }

    // حذف رسالة بمعرف تيليجرام
    async deleteByTelegramId(telegramMessageId) {
        const message = Array.from(this.cache.values()).find(
            msg => msg.telegramMessageId === telegramMessageId
        );
        
        if (message) {
            this.cache.delete(message.id);
            this.viewsCache.delete(message.id);
            await this.saveInstant();
            return true;
        }
        
        return false;
    }

    // مسح جميع الرسائل
    async clearAll() {
        const count = this.cache.size;
        this.cache.clear();
        this.viewsCache.clear();
        await this.saveInstant();
        return count;
    }
}
/**
 * نظام متابعة المشاهدة المتقدم
 */
class ViewTracker {
    constructor(telegramSystem) {
        this.telegramSystem = telegramSystem;
        this.trackedMessages = new Map();
        this.observers = new Map();
        this.isTracking = false;
        this.trackingInterval = null;
    }

    async init() {
        this.setupIntersectionObserver();
        this.setupVisibilityTracking();
        this.setupScrollTracking();
        console.log('👀 تم تهيئة نظام متابعة المشاهدة');
    }

    // بدء المتابعة العامة
    startGlobalTracking() {
        this.isTracking = true;
        
        // متابعة كل ثانية
        this.trackingInterval = setInterval(() => {
            this.checkVisibleMessages();
        }, 1000);
        
        // متابعة فورية عند التمرير
        this.setupScrollListener();
        
        console.log('🔍 بدء المتابعة العامة للمشاهدة');
    }

    // بدء متابعة رسالة محددة
    startTracking(messageId) {
        if (!this.trackedMessages.has(messageId)) {
            this.trackedMessages.set(messageId, {
                id: messageId,
                startTime: Date.now(),
                viewed: false,
                viewTime: null,
                viewDuration: 0,
                scrolledTo: false,
                fullyVisible: false
            });
            
            console.log(`👁️ بدء متابعة الرسالة: ${messageId}`);
        }
    }

    // إعداد مراقب التقاطع
    setupIntersectionObserver() {
        this.intersectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const messageId = entry.target.dataset.messageId;
                if (messageId && this.trackedMessages.has(messageId)) {
                    this.handleIntersection(messageId, entry);
                }
            });
        }, {
            threshold: [0.1, 0.5, 0.9], // مستويات مختلفة من الرؤية
            rootMargin: '0px'
        });
    }

    // معالجة التقاطع
    handleIntersection(messageId, entry) {
        const tracking = this.trackedMessages.get(messageId);
        
        if (entry.isIntersecting) {
            if (entry.intersectionRatio >= 0.5 && !tracking.viewed) {
                // الرسالة مرئية بنسبة 50% أو أكثر
                this.markAsViewed(messageId);
            }
            
            if (entry.intersectionRatio >= 0.9) {
                tracking.fullyVisible = true;
            }
        } else {
            tracking.fullyVisible = false;
        }
    }

    // إعداد متابعة الرؤية
    setupVisibilityTracking() {
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // عندما يعود المستخدم للصفحة
                setTimeout(() => {
                    this.checkVisibleMessages();
                }, 500);
            }
        });
    }

    // إعداد متابعة التمرير
    setupScrollTracking() {
        let scrollTimeout;
        
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                this.checkVisibleMessages();
            }, 100);
        });
    }

    // إعداد مستمع التمرير
    setupScrollListener() {
        let isScrolling = false;
        
        window.addEventListener('scroll', () => {
            if (!isScrolling) {
                isScrolling = true;
                requestAnimationFrame(() => {
                    this.updateScrollPositions();
                    isScrolling = false;
                });
            }
        });
    }

    // تحديث مواقع التمرير
    updateScrollPositions() {
        this.trackedMessages.forEach((tracking, messageId) => {
            const element = document.querySelector(`[data-message-id="${messageId}"]`);
            if (element) {
                const rect = element.getBoundingClientRect();
                const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                
                if (isVisible && !tracking.scrolledTo) {
                    tracking.scrolledTo = true;
                    console.log(`📜 تم التمرير للرسالة: ${messageId}`);
                }
            }
        });
    }

    // فحص الرسائل المرئية
    checkVisibleMessages() {
        if (!this.isTracking) return;
        
        this.trackedMessages.forEach((tracking, messageId) => {
            if (!tracking.viewed) {
                const element = document.querySelector(`[data-message-id="${messageId}"]`);
                if (element && this.isElementVisible(element)) {
                    this.markAsViewed(messageId);
                }
            }
        });
    }

    // فحص إذا كان العنصر مرئي
    isElementVisible(element) {
        const rect = element.getBoundingClientRect();
        const windowHeight = window.innerHeight || document.documentElement.clientHeight;
        const windowWidth = window.innerWidth || document.documentElement.clientWidth;
        
        // العنصر مرئي إذا كان 50% منه على الأقل في النافذة
        const verticalVisible = rect.top < windowHeight && rect.bottom > 0;
        const horizontalVisible = rect.left < windowWidth && rect.right > 0;
        const visibleHeight = Math.min(rect.bottom, windowHeight) - Math.max(rect.top, 0);
        const visibleRatio = visibleHeight / rect.height;
        
        return verticalVisible && horizontalVisible && visibleRatio >= 0.5;
    }

    // تمييز كمشاهدة
    async markAsViewed(messageId) {
        const tracking = this.trackedMessages.get(messageId);
        if (!tracking || tracking.viewed) return;
        
        tracking.viewed = true;
        tracking.viewTime = new Date().toISOString();
        tracking.viewDuration = Date.now() - tracking.startTime;
        
        // تحديث في قاعدة البيانات
        await this.telegramSystem.messageStore.markAsViewed(messageId, tracking.viewTime);
        
        // إرسال إشعار للتيليجرام
        await this.sendViewNotification(messageId, tracking);
        
        // تحديث الواجهة
        this.telegramSystem.emit('message:viewed', { messageId, tracking });
        
        // تحديث الإحصائيات
        this.telegramSystem.state.viewedMessages++;
        
        console.log(`✅ تم تمييز الرسالة كمشاهدة: ${messageId}`);
    }

    // إرسال إشعار المشاهدة
    async sendViewNotification(messageId, tracking) {
        const message = await this.telegramSystem.messageStore.getMessage(messageId);
        if (!message) return;
        
        const viewTime = new Date(tracking.viewTime);
        const duration = Math.round(tracking.viewDuration / 1000);
        
        const notificationText = `
👀 تم مشاهدة رسالتك!

💌 الرسالة: "${message.text.substring(0, 50)}${message.text.length > 50 ? '...' : ''}"

⏰ معلومات المشاهدة:
• وقت المشاهدة: ${viewTime.toLocaleTimeString('ar-SA')}
• تاريخ المشاهدة: ${viewTime.toLocaleDateString('ar-SA')}
• مدة الوصول: ${duration} ثانية

💕 حبيبتك شاهدت رسالتك الآن!
        `.trim();
        
        await this.telegramSystem.sendMessageInstant(notificationText);
        
        // إضافة تأثيرات بصرية في الواجهة
        this.addViewEffect(messageId);
    }

    // إضافة تأثير بصري للمشاهدة
    addViewEffect(messageId) {
        const element = document.querySelector(`[data-message-id="${messageId}"]`);
        if (element) {
            element.classList.add('message-viewed');
            
            // إضافة أيقونة المشاهدة
            const viewIcon = document.createElement('div');
            viewIcon.className = 'view-indicator';
            viewIcon.innerHTML = '👀 تم المشاهدة';
            element.appendChild(viewIcon);
            
            // تأثير وميض
            element.style.animation = 'viewedFlash 2s ease-in-out';
        }
    }

    // مراقبة عنصر جديد
    observeElement(element, messageId) {
        if (this.intersectionObserver && element) {
            element.dataset.messageId = messageId;
            this.intersectionObserver.observe(element);
            this.startTracking(messageId);
        }
    }

    // إلغاء مراقبة عنصر
    unobserveElement(element) {
        if (this.intersectionObserver && element) {
            this.intersectionObserver.unobserve(element);
        }
    }

    // الحصول على إحصائيات المشاهدة
    getViewStats() {
        const totalTracked = this.trackedMessages.size;
        const totalViewed = Array.from(this.trackedMessages.values()).filter(t => t.viewed).length;
        const averageViewTime = this.calculateAverageViewTime();
        
        return {
            totalTracked,
            totalViewed,
            viewRate: totalTracked > 0 ? (totalViewed / totalTracked * 100).toFixed(1) : 0,
            averageViewTime
        };
    }

    // حساب متوسط وقت المشاهدة
    calculateAverageViewTime() {
        const viewedMessages = Array.from(this.trackedMessages.values()).filter(t => t.viewed);
        if (viewedMessages.length === 0) return 0;
        
        const totalDuration = viewedMessages.reduce((sum, t) => sum + t.viewDuration, 0);
        return Math.round(totalDuration / viewedMessages.length / 1000); // بالثواني
    }

    // تنظيف الموارد
    cleanup() {
        if (this.trackingInterval) {
            clearInterval(this.trackingInterval);
        }
        
        if (this.intersectionObserver) {
            this.intersectionObserver.disconnect();
        }
        
        this.isTracking = false;
        console.log('🧹 تم تنظيف نظام متابعة المشاهدة');
    }
}
/**
 * نظام الإرسال المباشر والمتابعة المتقدم
 * Advanced Direct Send & Tracking System
 */
class AdvancedTelegramSystem {
    constructor() {
        this.config = {
            botToken: TELEGRAM_CONFIG.BOT_TOKEN,
            chatId: TELEGRAM_CONFIG.CHAT_ID,
            instantSync: true,
            syncInterval: 1000, // ثانية واحدة
            maxRetries: 5,
            timeout: 5000,
            batchSize: 100,
            trackViews: true,
            autoConnect: true
        };
        
        this.state = {
            isOnline: false,
            lastHeartbeat: null,
            connectionQuality: 'excellent',
            messageQueue: new Map(),
            viewTracker: new Map(),
            syncTimer: null,
            heartbeatTimer: null,
            retryCount: 0,
            totalMessages: 0,
            viewedMessages: 0
        };
        
        this.events = new EventTarget();
        this.messageStore = new AdvancedMessageStore();
        this.viewTracker = new ViewTracker(this);
        this.directSender = new DirectSender(this);
        this.uiManager = new AdvancedUIManager(this);
        
        this.init();
    }

    // تهيئة فورية ومتقدمة
    async init() {
        try {
            console.log('🚀 تهيئة النظام المتقدم...');
            
            // تهيئة فورية بدون انتظار
            await Promise.all([
                this.messageStore.init(),
                this.viewTracker.init(),
                this.directSender.init(),
                this.uiManager.init()
            ]);
            
            // بدء الاتصال التلقائي الفوري
            await this.startInstantConnection();
            
            // تفعيل المتابعة المباشرة
            this.startViewTracking();
            
            // تفعيل نبضات القلب
            this.startHeartbeat();
            
            this.state.isOnline = true;
            this.emit('system:ready');
            
            console.log('✅ النظام المتقدم جاهز للعمل');
            
        } catch (error) {
            console.error('❌ خطأ في التهيئة:', error);
            this.handleConnectionError(error);
        }
    }

    // اتصال فوري تلقائي
    async startInstantConnection() {
        // مزامنة فورية
        await this.instantSync();
        
        // مزامنة كل ثانية
        this.state.syncTimer = setInterval(() => {
            this.instantSync();
        }, this.config.syncInterval);
        
        console.log('⚡ تم تفعيل المزامنة الفورية (كل ثانية)');
    }

    // مزامنة فورية
    async instantSync() {
        if (this.state.isProcessing) return;
        
        try {
            this.state.isProcessing = true;
            
            const updates = await this.fetchUpdatesInstant();
            
            if (updates.length > 0) {
                // معالجة فورية متوازية
                await Promise.all(updates.map(update => this.processUpdateInstant(update)));
                this.updateLastUpdateId(updates);
                this.emit('sync:instant', { count: updates.length });
            }
            
            this.state.retryCount = 0;
            this.updateConnectionQuality('excellent');
            
        } catch (error) {
            this.handleSyncError(error);
        } finally {
            this.state.isProcessing = false;
        }
    }

    // جلب التحديثات الفوري
    async fetchUpdatesInstant() {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.config.timeout);
        
        try {
            const response = await fetch(`https://api.telegram.org/bot${this.config.botToken}/getUpdates`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    offset: this.getLastUpdateId() + 1,
                    limit: this.config.batchSize,
                    timeout: 1 // استقبال فوري
                }),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            const data = await response.json();
            
            return data.ok ? data.result : [];
            
        } catch (error) {
            clearTimeout(timeoutId);
            throw error;
        }
    }

    // معالجة فورية للتحديث
    async processUpdateInstant(update) {
        this.setLastUpdateId(update.update_id);
        
        if (update.message) {
            await this.handleInstantMessage(update.message);
        } else if (update.edited_message) {
            await this.handleEditedMessage(update.edited_message);
        }
    }

    // معالجة الرسائل الفورية
    async handleInstantMessage(message) {
        const messageData = {
            id: message.message_id,
            text: message.text,
            from: message.from,
            date: message.date,
            chat: message.chat
        };
        
        // معالجة الأوامر
        if (messageData.text?.startsWith('/')) {
            await this.processCommand(messageData);
            return;
        }
        
        // معالجة الرسائل العادية فوراً
        if (messageData.text?.trim()) {
            await this.addMessageInstant(messageData);
        }
    }

    // إضافة رسالة فورية
    async addMessageInstant(messageData) {
        const quote = await this.messageStore.addMessageInstant({
            text: messageData.text.trim(),
            author: messageData.from.first_name || 'حبيبي',
            telegramMessageId: messageData.id,
            telegramUserId: messageData.from.id,
            source: 'telegram',
            timestamp: new Date(messageData.date * 1000).toISOString(),
            viewed: false,
            viewTime: null
        });
        
        // إرسال تأكيد فوري
        await this.sendInstantConfirmation(messageData.id, quote);
        
        // تحديث الواجهة فوراً
        this.emit('message:instant', quote);
        
        // بدء متابعة المشاهدة
        this.viewTracker.startTracking(quote.id);
        
        console.log('⚡ تم إضافة رسالة فورية:', messageData.text.substring(0, 30));
    }

    // إرسال تأكيد فوري
    async sendInstantConfirmation(replyToId, quote) {
        const totalMessages = this.state.totalMessages + 1;
        this.state.totalMessages = totalMessages;
        
        const confirmationText = `
⚡ تم إرسال رسالتك فوراً!

📊 معلومات سريعة:
• رقم الرسالة: #${totalMessages}
• الوقت: ${new Date().toLocaleTimeString('ar-SA')}
• الحالة: 🟢 مرسلة ومعروضة

👀 سيتم إشعارك عند مشاهدة الرسالة

💕 رسالتك الآن تضيء الموقع!
        `.trim();
        
        await this.sendMessageInstant(confirmationText, replyToId);
    }

    // إرسال رسالة فوري
    async sendMessageInstant(text, replyToId = null) {
        const params = {
            chat_id: this.config.chatId,
            text: text,
            parse_mode: 'HTML',
            disable_web_page_preview: true
        };
        
        if (replyToId) {
            params.reply_to_message_id = replyToId;
        }
        
        try {
            const response = await fetch(`https://api.telegram.org/bot${this.config.botToken}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params),
                signal: AbortSignal.timeout(3000) // 3 ثوان حد أقصى
            });
            
            return await response.json();
        } catch (error) {
            console.error('خطأ في الإرسال الفوري:', error);
        }
    }

    // نبضات القلب للاتصال
    startHeartbeat() {
        this.state.heartbeatTimer = setInterval(async () => {
            try {
                const start = Date.now();
                await this.sendHeartbeat();
                const latency = Date.now() - start;
                
                this.updateConnectionQuality(latency);
                this.state.lastHeartbeat = new Date();
                
            } catch (error) {
                this.updateConnectionQuality('poor');
                console.warn('نبضة قلب فاشلة:', error);
            }
        }, 5000); // كل 5 ثوان
    }

    // إرسال نبضة قلب
    async sendHeartbeat() {
        const response = await fetch(`https://api.telegram.org/bot${this.config.botToken}/getMe`, {
            signal: AbortSignal.timeout(2000)
        });
        return response.json();
    }

    // تحديث جودة الاتصال
    updateConnectionQuality(latencyOrStatus) {
        if (typeof latencyOrStatus === 'number') {
            if (latencyOrStatus < 500) {
                this.state.connectionQuality = 'excellent';
            } else if (latencyOrStatus < 1000) {
                this.state.connectionQuality = 'good';
            } else if (latencyOrStatus < 2000) {
                this.state.connectionQuality = 'fair';
            } else {
                this.state.connectionQuality = 'poor';
            }
        } else {
            this.state.connectionQuality = latencyOrStatus;
        }
        
        this.emit('connection:quality', this.state.connectionQuality);
    }

    // بدء متابعة المشاهدة
    startViewTracking() {
        this.viewTracker.startGlobalTracking();
        console.log('👀 تم تفعيل متابعة المشاهدة');
    }

    // معالجة أخطاء الاتصال
    handleConnectionError(error) {
        this.state.retryCount++;
        this.updateConnectionQuality('error');
        
        if (this.state.retryCount < this.config.maxRetries) {
            setTimeout(() => {
                console.log(`🔄 إعادة المحاولة ${this.state.retryCount}/${this.config.maxRetries}`);
                this.init();
            }, 2000 * this.state.retryCount);
        }
    }

    // معالجة أخطاء المزامنة
    handleSyncError(error) {
        this.state.retryCount++;
        this.updateConnectionQuality('poor');
        
        if (this.state.retryCount >= this.config.maxRetries) {
            console.error('❌ فشل في الاتصال نهائياً');
            this.emit('connection:failed');
        }
    }

    // الحصول على آخر معرف تحديث
    getLastUpdateId() {
        return parseInt(localStorage.getItem('telegram_last_update_id') || '0');
    }

    // تعيين آخر معرف تحديث
    setLastUpdateId(updateId) {
        localStorage.setItem('telegram_last_update_id', updateId.toString());
    }

    // تحديث آخر معرف تحديث
    updateLastUpdateId(updates) {
        if (updates.length > 0) {
            const maxId = Math.max(...updates.map(u => u.update_id));
            this.setLastUpdateId(maxId);
        }
    }

    // إطلاق حدث
    emit(eventName, data = null) {
        this.events.dispatchEvent(new CustomEvent(eventName, { detail: data }));
    }

    // الاستماع لحدث
    on(eventName, callback) {
        this.events.addEventListener(eventName, callback);
    }

    // تنظيف الموارد
    cleanup() {
        if (this.state.syncTimer) {
            clearInterval(this.state.syncTimer);
        }
        if (this.state.heartbeatTimer) {
            clearInterval(this.state.heartbeatTimer);
        }
        this.viewTracker.cleanup();
    }

    // الحصول على حالة النظام
    getSystemStatus() {
        return {
            isOnline: this.state.isOnline,
            connectionQuality: this.state.connectionQuality,
            lastHeartbeat: this.state.lastHeartbeat,
            totalMessages: this.state.totalMessages,
            viewedMessages: this.state.viewedMessages,
            retryCount: this.state.retryCount
        };
    }
}

    </script>
</body>
</html>
